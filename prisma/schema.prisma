// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  passwordHash     String   @map("password_hash")
  name             String
  role             Role     @default(LEARNER)
  learningProgress Json     @default("{}") @map("learning_progress")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  projects         Project[]
  learningRecords  LearningRecord[]

  @@map("users")
}

model Project {
  id                 String        @id @default(cuid())
  name               String
  description        String?
  githubRepo         String?       @map("github_repo")
  gitlabProjectId    Int?          @map("gitlab_project_id")
  techStack          String[]      @map("tech_stack")
  status             ProjectStatus @default(ACTIVE)
  learningObjectives String[]      @map("learning_objectives")
  createdBy          String        @map("created_by")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  user        User         @relation(fields: [createdBy], references: [id])
  deployments Deployment[]
  pipelines   Pipeline[]

  @@map("projects")
}

model Cluster {
  id            String        @id @default(cuid())
  name          String
  kubeconfig    String?
  status        ClusterStatus @default(HEALTHY)
  nodeInfo      Json          @default("{}") @map("node_info")
  resourceUsage Json          @default("{}") @map("resource_usage")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  deployments       Deployment[]
  monitoringTargets MonitoringTarget[]

  @@map("clusters")
}

model Deployment {
  id             String           @id @default(cuid())
  projectId      String           @map("project_id")
  clusterId      String           @map("cluster_id")
  namespace      String           @default("default")
  deploymentName String           @map("deployment_name")
  status         DeploymentStatus @default(PENDING)
  manifest       Json             @default("{}")
  deployedAt     DateTime         @default(now()) @map("deployed_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cluster Cluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)

  @@map("deployments")
}

model Pipeline {
  id               String         @id @default(cuid())
  projectId        String         @map("project_id")
  gitlabPipelineId Int            @map("gitlab_pipeline_id")
  status           PipelineStatus @default(PENDING)
  stages           Json           @default("[]")
  startedAt        DateTime?      @map("started_at")
  finishedAt       DateTime?      @map("finished_at")
  createdAt        DateTime       @default(now()) @map("created_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("pipelines")
}

model LearningRecord {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  techStack     String   @map("tech_stack")
  progressScore Int      @default(0) @map("progress_score")
  learningData  Json     @default("{}") @map("learning_data")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("learning_records")
}

model MonitoringTarget {
  id            String   @id @default(cuid())
  clusterId     String   @map("cluster_id")
  targetType    String   @map("target_type")
  targetName    String   @map("target_name")
  metricsConfig Json     @default("{}") @map("metrics_config")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  cluster Cluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)

  @@map("monitoring_targets")
}

// Code Quality Management Tables
model CodeQualityReport {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  branch      String
  commitHash  String   @map("commit_hash")
  overallScore Float   @map("overall_score")
  coverage    Float    @default(0)
  bugs        Int      @default(0)
  vulnerabilities Int  @default(0)
  codeSmells  Int      @default(0) @map("code_smells")
  duplicatedLines Int  @default(0) @map("duplicated_lines")
  reportData  Json     @default("{}") @map("report_data")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("code_quality_reports")
}

model CodeQualityMetric {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  metricType String  @map("metric_type")
  value     Float
  threshold Float?
  status    String   @default("PASS")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("code_quality_metrics")
}

model TestCoverage {
  id            String   @id @default(cuid())
  projectId     String   @map("project_id")
  branch        String
  commitHash    String   @map("commit_hash")
  lineCoverage  Float    @map("line_coverage")
  branchCoverage Float   @map("branch_coverage")
  functionCoverage Float @map("function_coverage")
  statementCoverage Float @map("statement_coverage")
  coverageData  Json     @default("{}") @map("coverage_data")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("test_coverage")
}

model QualityGate {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  name        String
  conditions  Json     @default("[]")
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("quality_gates")
}

model TechnicalDebt {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  debtType    String   @map("debt_type")
  severity    String
  effort      String   // Time estimate to fix
  description String
  filePath    String   @map("file_path")
  lineNumber  Int?     @map("line_number")
  rule        String?
  isResolved  Boolean  @default(false) @map("is_resolved")
  createdAt   DateTime @default(now()) @map("created_at")
  resolvedAt  DateTime? @map("resolved_at")

  @@map("technical_debt")
}

// Enums
enum Role {
  LEARNER
  MENTOR
  ADMIN
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum ClusterStatus {
  HEALTHY
  WARNING
  ERROR
}

enum DeploymentStatus {
  PENDING
  RUNNING
  FAILED
  STOPPED
}

enum PipelineStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  CANCELED
}