name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/juanie

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - run: bun install --frozen-lockfile
      - run: bun run lint
      - run: bun run build

  build:
    needs: quality
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  migrate:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: å¤åˆ¶è¿ç§»æ–‡ä»¶åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "migrations/*.sql"
          target: "/tmp/juanie-migrations"
          strip_components: 0

      - name: è¿è¡Œæ•°æ®åº“è¿ç§»
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."

            # ç¡®ä¿è¿ç§»è®°å½•è¡¨å­˜åœ¨
            kubectl exec -n juanie postgres-0 -- psql -U postgres -d juanie -c "
              CREATE TABLE IF NOT EXISTS \"_migrations\" (
                \"id\" serial PRIMARY KEY,
                \"name\" varchar(255) NOT NULL UNIQUE,
                \"executed_at\" timestamp NOT NULL DEFAULT NOW()
              );
            "

            # è¿ç§»æ–‡ä»¶åˆ—è¡¨
            MIGRATIONS="000_migration_tracker.sql 001_init.sql"

            for migration in $MIGRATIONS; do
              EXISTS=$(kubectl exec -n juanie postgres-0 -- psql -U postgres -d juanie -tAc \
                "SELECT COUNT(*) FROM \"_migrations\" WHERE \"name\" = '$migration'")

              if [ "$EXISTS" = "0" ]; then
                echo "ğŸ“Œ æ‰§è¡Œè¿ç§»: $migration"
                kubectl cp /tmp/juanie-migrations/migrations/$migration juanie/postgres-0:/tmp/$migration
                kubectl exec -n juanie postgres-0 -- psql -U postgres -d juanie -v ON_ERROR_STOP=1 -f /tmp/$migration
                kubectl exec -n juanie postgres-0 -- psql -U postgres -d juanie -c \
                  "INSERT INTO \"_migrations\" (\"name\") VALUES ('$migration')"
                echo "âœ… è¿ç§»å®Œæˆ: $migration"
              else
                echo "â­ï¸  è·³è¿‡å·²æ‰§è¡Œçš„è¿ç§»: $migration"
              fi
            done

            echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ!"
            rm -rf /tmp/juanie-migrations

  deploy:
    needs: migrate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: éƒ¨ç½²åˆ° Kubernetes
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

            echo "ğŸš€ éƒ¨ç½² Juanie..."
            echo "   é•œåƒ: $IMAGE"

            # éƒ¨ç½² web
            kubectl set image deployment/juanie-web -n juanie \
              web=$IMAGE --record

            # éƒ¨ç½² worker
            kubectl set image deployment/juanie-worker -n juanie \
              worker=$IMAGE --record

            # ç­‰å¾…æ»šåŠ¨æ›´æ–°å®Œæˆ
            kubectl rollout status deployment/juanie-web -n juanie --timeout=120s
            kubectl rollout status deployment/juanie-worker -n juanie --timeout=120s

            echo "âœ… éƒ¨ç½²å®Œæˆ!"
