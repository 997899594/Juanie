name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/juanie

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - run: bun install --frozen-lockfile
      - run: bun run lint
      - run: bun run build

  # æ„å»ºå¹¶æ¨é€é•œåƒï¼Œæ›´æ–° Git ä»“åº“ä¸­çš„ tag
  build:
    needs: quality
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: æ›´æ–° Helm values ä¸­çš„é•œåƒ tag
        run: |
          # æ›´æ–° values.yaml ä¸­çš„ tag
          sed -i "s|tag: .*|tag: \"${{ github.sha }}\"|" deploy/flux/charts/juanie/values.yaml

          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æäº¤å¹¶æ¨é€
          git add deploy/flux/charts/juanie/values.yaml
          git commit -m "chore: æ›´æ–°é•œåƒ tag åˆ° ${{ github.sha }} [skip ci]"
          git push

  # è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¯é€‰ï¼Œé€šè¿‡ SSHï¼‰
  migrate:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: å¤åˆ¶è¿ç§»æ–‡ä»¶åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "migrations/*.sql"
          target: "/tmp/juanie-migrations"
          strip_components: 0

      - name: è¿è¡Œæ•°æ®åº“è¿ç§»
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."

            # ç¡®ä¿è¿ç§»è®°å½•è¡¨å­˜åœ¨
            kubectl exec -n juanie postgres-0 -- psql -U postgres -d juanie -c "
              CREATE TABLE IF NOT EXISTS \"_migrations\" (
                \"id\" serial PRIMARY KEY,
                \"name\" varchar(255) NOT NULL UNIQUE,
                \"executed_at\" timestamp NOT NULL DEFAULT NOW()
              );
            "

            # è¿ç§»æ–‡ä»¶åˆ—è¡¨
            MIGRATIONS="000_migration_tracker.sql 001_init.sql"

            for migration in $MIGRATIONS; do
              EXISTS=$(kubectl exec -n juanie postgres-0 -- psql -U postgres -d juanie -tAc \
                "SELECT COUNT(*) FROM \"_migrations\" WHERE \"name\" = '$migration'")

              if [ "$EXISTS" = "0" ]; then
                echo "ğŸ“Œ æ‰§è¡Œè¿ç§»: $migration"
                kubectl cp /tmp/juanie-migrations/migrations/$migration juanie/postgres-0:/tmp/$migration
                kubectl exec -n juanie postgres-0 -- psql -U postgres -d juanie -v ON_ERROR_STOP=1 -f /tmp/$migration
                kubectl exec -n juanie postgres-0 -- psql -U postgres -d juanie -c \
                  "INSERT INTO \"_migrations\" (\"name\") VALUES ('$migration')"
                echo "âœ… è¿ç§»å®Œæˆ: $migration"
              else
                echo "â­ï¸  è·³è¿‡å·²æ‰§è¡Œçš„è¿ç§»: $migration"
              fi
            done

            echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ!"
            rm -rf /tmp/juanie-migrations
