# AI DevOps 平台完整使用流程

## 概述

本文档描述了从零开始使用 AI DevOps 平台的完整流程，包括组织管理、项目创建、GitOps 配置和应用部署。

---

## 阶段 1: 初始化设置（管理员）

### 1.1 系统登录
**位置：** `/login`

1. 使用 OAuth 登录（GitHub/GitLab）
2. 首次登录自动创建用户账号

### 1.2 安装 Flux（一次性，系统级）
**位置：** `设置 → GitOps`

**前置条件：**
- K3s 集群已部署并运行
- 有集群管理员权限

**操作步骤：**
1. 进入系统设置
2. 切换到 GitOps 标签
3. 点击"安装 Flux"
4. 等待安装完成（约 30-60 秒）
5. 验证组件状态（source-controller, kustomize-controller, helm-controller, notification-controller）

**结果：**
- Flux v2 安装到 `flux-system` 命名空间
- 所有组件状态显示为"就绪"

---

## 阶段 2: 组织和团队管理

### 2.1 创建组织
**位置：** `组织管理 → 新建组织`

**操作步骤：**
1. 点击"新建组织"
2. 填写组织信息：
   - 组织名称（如：我的公司）
   - 组织标识（slug，如：my-company）
   - 显示名称（可选）
3. 提交创建

**结果：**
- 创建者自动成为组织管理员
- 组织出现在组织列表中

### 2.2 邀请成员
**位置：** `组织详情 → 成员标签`

**操作步骤：**
1. 点击"邀请成员"
2. 输入用户邮箱或用户名
3. 选择角色（admin / member）
4. 发送邀请

### 2.3 创建团队（可选）
**位置：** `组织详情 → 团队标签`

**操作步骤：**
1. 点击"新建团队"
2. 填写团队信息：
   - 团队名称（如：前端团队）
   - 团队标识（slug）
   - 描述
3. 添加团队成员
4. 分配角色（owner / maintainer / member）

**用途：**
- 批量管理项目权限
- 团队级别的资源隔离

---

## 阶段 3: 项目创建和配置

### 3.1 创建项目
**位置：** `项目管理 → 新建项目`

**操作步骤：**
1. 点击"新建项目"
2. 填写项目信息：
   - 项目名称（如：电商平台）
   - 项目标识（slug，如：ecommerce）
   - 描述
   - 可见性（public / private / internal）
3. 选择所属组织
4. 提交创建

**结果：**
- 项目创建成功
- 创建者自动成为项目 owner
- 跳转到项目详情页

### 3.2 连接代码仓库
**位置：** `项目详情 → 仓库标签 → 连接仓库`

**操作步骤：**
1. 点击"连接仓库"
2. 选择提供商（GitHub / GitLab）
3. 填写仓库信息：
   - 仓库 URL（如：https://github.com/org/repo）
   - 访问令牌（Personal Access Token）
   - 默认分支（可选，默认 main）
4. 提交连接

**访问令牌权限要求：**
- GitHub: `repo` 权限
- GitLab: `read_repository` 权限

**结果：**
- 仓库连接成功
- 显示仓库信息和同步状态
- 可以查看分支、提交历史

### 3.3 创建环境
**位置：** `项目详情 → 环境标签 → 新建环境`

**操作步骤：**
1. 点击"新建环境"
2. 填写环境信息：
   - 环境名称（如：生产环境）
   - 环境类型（development / staging / production / testing）
   - 云服务商（AWS / GCP / Azure）
   - 区域
3. 配置审批设置（生产环境建议启用）：
   - 是否需要审批
   - 最少审批人数
4. 提交创建

**建议配置：**

```
开发环境 (development):
  - 类型: development
  - 审批: 不需要
  - 用途: 开发测试

测试环境 (staging):
  - 类型: staging
  - 审批: 不需要
  - 用途: 集成测试

生产环境 (production):
  - 类型: production
  - 审批: 需要（至少 2 人）
  - 用途: 正式发布
```

### 3.4 配置环境的 GitOps（可选但推荐）
**位置：** `项目详情 → 环境标签 → 环境卡片 → 编辑 → GitOps 配置`

**操作步骤：**
1. 点击环境卡片的"编辑"按钮
2. 切换到"GitOps 配置"标签
3. 启用 GitOps
4. 配置 GitOps 参数：
   - **Git 分支**：该环境对应的分支（如 main, develop）
   - **配置路径**：K8s 配置文件路径（如 k8s/overlays/production）
   - **同步间隔**：Flux 检查间隔（如 5m）
   - **自动同步**：是否自动应用变更
5. 保存配置

**不同环境的 GitOps 配置示例：**

```yaml
开发环境:
  enabled: true
  gitBranch: develop
  gitPath: k8s/overlays/development
  syncInterval: 1m
  autoSync: true        # 自动同步，快速迭代

测试环境:
  enabled: true
  gitBranch: staging
  gitPath: k8s/overlays/staging
  syncInterval: 5m
  autoSync: true        # 自动同步

生产环境:
  enabled: true
  gitBranch: main
  gitPath: k8s/overlays/production
  syncInterval: 10m
  autoSync: false       # 手动触发，更安全
```

---

## 阶段 4: GitOps 资源配置（可选，高级用户）

### 4.1 创建 Kustomization 资源
**位置：** `项目详情 → GitOps 标签` 或 `GitOps 资源（全局）`

**什么时候需要：**
- 使用 Kubernetes 原生 YAML
- 需要 Kustomize 覆盖和补丁
- 多环境配置管理

**操作步骤：**
1. 点击"创建 GitOps 资源"
2. 选择类型：Kustomization
3. 填写基本信息：
   - 资源名称（如：my-app-prod）
   - 命名空间（如：default）
   - 选择环境
   - 选择仓库
4. 配置 Kustomization：
   - 配置路径（如：./k8s/overlays/production）
   - 同步间隔（如：5m）
   - 超时时间（如：3m）
   - 启用 Prune（自动删除不存在的资源）
5. 配置健康检查（可选）：
   - 添加需要检查的资源（Deployment, Service 等）
6. 配置依赖关系（可选）：
   - 如果依赖其他资源，添加依赖
7. 提交创建

**结果：**
- Flux 创建 Kustomization 资源
- 开始监控 Git 仓库
- 自动同步配置到集群

### 4.2 创建 HelmRelease 资源
**位置：** 同上

**什么时候需要：**
- 使用 Helm Chart 部署
- 需要管理 Helm values
- 使用社区 Chart

**操作步骤：**
1. 选择类型：HelmRelease
2. 填写基本信息（同上）
3. 配置 Helm：
   - Chart 名称
   - Chart 版本
   - 源类型（GitRepository / HelmRepository）
   - Values 配置（YAML 格式）
4. 配置升级策略：
   - 失败重试次数
   - 自动修复
   - 失败时清理
5. 提交创建

---

## 阶段 5: 应用部署

### 方式 1: GitOps 部署（推荐）

#### 5.1.1 通过 UI 部署
**位置：** `项目详情 → 部署标签 → GitOps 部署`

**适用场景：**
- 快速部署新版本
- 不熟悉 YAML 的用户
- 需要可视化配置

**操作步骤：**
1. 点击"GitOps 部署"按钮
2. 选择环境
3. 填写部署配置：

   **镜像配置：**
   ```
   镜像: ghcr.io/org/my-app:v1.2.3
   拉取策略: IfNotPresent
   ```

   **副本数：**
   ```
   副本数: 3
   ```

   **环境变量：**
   ```
   NODE_ENV = production
   API_URL = https://api.example.com
   DATABASE_URL = postgresql://...
   ```

   **资源配置：**
   ```
   资源请求:
     CPU: 100m
     内存: 128Mi
   
   资源限制:
     CPU: 500m
     内存: 512Mi
   ```

4. 切换到"YAML 预览"查看生成的配置
5. 切换到"变更对比"查看与当前版本的差异
6. 输入 Commit 消息：
   ```
   Deploy v1.2.3 to production
   
   - 修复了登录问题
   - 优化了性能
   ```
7. 点击"提交部署"

**部署流程：**
```
UI 表单
  ↓
生成 K8s YAML
  ↓
创建 Git Commit
  ↓
Push 到远程仓库
  ↓
Flux 检测到变更（1-10 分钟，取决于同步间隔）
  ↓
Flux 应用配置到集群
  ↓
Kubernetes 创建/更新资源
  ↓
Pod 启动并通过健康检查
  ↓
部署完成
```

**查看部署进度：**
- 自动跳转到部署详情页
- 显示 4 步进度：
  1. Git Commit ✓
  2. Flux 同步 ⏳
  3. K8s 应用 ⏳
  4. 健康检查 ⏳

#### 5.1.2 通过 Git Push 部署
**位置：** 本地 Git 仓库

**适用场景：**
- 熟悉 YAML 的开发者
- 需要代码审查
- 批量修改配置

**操作步骤：**
1. 克隆仓库到本地：
   ```bash
   git clone https://github.com/org/repo.git
   cd repo
   ```

2. 切换到对应分支：
   ```bash
   git checkout main  # 生产环境
   # 或
   git checkout develop  # 开发环境
   ```

3. 修改 K8s 配置文件：
   ```bash
   vim k8s/overlays/production/deployment.yaml
   ```

   修改镜像版本：
   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: my-app
   spec:
     replicas: 3
     template:
       spec:
         containers:
         - name: app
           image: ghcr.io/org/my-app:v1.2.3  # 修改这里
   ```

4. 提交变更：
   ```bash
   git add .
   git commit -m "chore(deploy): update to v1.2.3"
   git push origin main
   ```

5. Flux 自动检测并部署

**部署流程：**
```
修改 YAML
  ↓
Git Commit & Push
  ↓
Flux 检测到变更
  ↓
Flux 应用配置
  ↓
部署完成
```

### 方式 2: Pipeline 部署

#### 5.2.1 创建 Pipeline
**位置：** `项目详情 → Pipeline 标签 → 新建 Pipeline`

**操作步骤：**
1. 点击"新建 Pipeline"
2. 填写 Pipeline 信息：
   - Pipeline 名称
   - 触发条件（push / PR / 定时）
3. 配置 Stage：
   ```yaml
   stages:
     - name: build
       type: build
       command: npm run build
       timeout: 300
     
     - name: test
       type: test
       command: npm test
       timeout: 300
     
     - name: deploy
       type: deploy
       command: kubectl apply -f k8s/
       timeout: 300
   ```
4. 保存 Pipeline

#### 5.2.2 触发 Pipeline
**位置：** `项目详情 → Pipeline 标签`

**操作步骤：**
1. 找到要运行的 Pipeline
2. 点击"运行"按钮
3. 选择分支和 Commit
4. 确认运行

**查看运行状态：**
- 点击运行记录查看详情
- 实时查看日志输出
- 查看每个 Stage 的状态

### 方式 3: 手动部署

**位置：** `项目详情 → 部署标签 → 新建部署`

**适用场景：**
- 临时部署
- 不使用 GitOps
- 快速测试

**操作步骤：**
1. 点击"新建部署"
2. 选择环境
3. 填写部署信息：
   - 版本号
   - Commit Hash
   - 分支
   - 部署策略（rolling / blue_green / canary）
4. 提交部署

---

## 阶段 6: 监控和管理

### 6.1 查看部署历史
**位置：** `项目详情 → 部署标签` 或 `部署记录（全局）`

**可以看到：**
- 所有部署记录
- 部署状态（成功/失败/进行中）
- 部署方式（GitOps UI / GitOps Git / Pipeline / 手动）
- Git Commit 信息
- 部署时间和耗时

**筛选和搜索：**
- 按环境筛选
- 按状态筛选
- 按时间范围筛选

### 6.2 查看 GitOps 资源状态
**位置：** `项目详情 → GitOps 标签` 或 `GitOps 资源（全局）`

**可以看到：**
- 所有 GitOps 资源
- 同步状态（就绪/同步中/失败）
- 最后同步时间
- 最后应用的 Commit
- 错误信息（如果有）

**操作：**
- 手动触发同步
- 暂停/恢复自动同步
- 编辑资源配置
- 删除资源

### 6.3 查看仓库同步状态
**位置：** `项目详情 → 仓库标签`

**可以看到：**
- 仓库连接状态
- 最后同步时间
- Flux 同步状态（如果启用了 GitOps）
- 分支信息

**操作：**
- 手动同步仓库
- 启用/禁用 GitOps
- 断开仓库连接

### 6.4 监控和告警
**位置：** `监控 → GitOps` 或 `监控告警`

**可以看到：**
- GitOps 资源总数和健康状态
- 同步成功率
- 同步延迟
- Flux 组件状态

**配置告警：**
- Flux 同步失败
- 同步延迟过高
- 组件异常

### 6.5 审计日志
**位置：** `安全与合规 → 审计日志`

**可以看到：**
- 所有操作记录
- 操作人
- 操作时间
- 操作内容
- 操作结果

**筛选：**
- 按用户筛选
- 按操作类型筛选
- 按资源类型筛选
- 按时间范围筛选

---

## 阶段 7: 回滚和故障处理

### 7.1 回滚部署
**位置：** `部署详情 → 回滚按钮`

**操作步骤：**
1. 在部署历史中找到要回滚到的版本
2. 点击"回滚"按钮
3. 确认回滚
4. 系统自动：
   - 创建回滚 Commit
   - Push 到 Git
   - Flux 自动应用

### 7.2 故障排查

#### 部署失败
1. 查看部署详情中的错误信息
2. 检查 Pod 日志
3. 检查事件记录
4. 常见问题：
   - 镜像拉取失败（ImagePullBackOff）
   - 资源不足（Insufficient resources）
   - 配置错误（CrashLoopBackOff）

#### Flux 同步失败
1. 查看 GitOps 资源详情
2. 检查错误信息
3. 常见问题：
   - Git 认证失败
   - YAML 语法错误
   - 资源冲突
   - 依赖资源未就绪

#### 手动干预
**位置：** `GitOps 资源 → 手动同步`

1. 暂停自动同步
2. 手动修复问题
3. 手动触发同步
4. 恢复自动同步

---

## 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    1. 初始化设置（一次性）                      │
│                                                               │
│  登录系统 → 安装 Flux → 验证 Flux 状态                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    2. 组织和团队管理                           │
│                                                               │
│  创建组织 → 邀请成员 → 创建团队（可选）                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    3. 项目创建和配置                           │
│                                                               │
│  创建项目 → 连接仓库 → 创建环境 → 配置 GitOps（可选）           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              4. GitOps 资源配置（可选，高级用户）               │
│                                                               │
│  创建 Kustomization 或 HelmRelease 资源                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      5. 应用部署                              │
│                                                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ GitOps 部署 │  │Pipeline 部署│  │  手动部署   │          │
│  │  (推荐)     │  │             │  │             │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│         │                 │                 │                │
│         └─────────────────┴─────────────────┘                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    6. 监控和管理                              │
│                                                               │
│  查看部署历史 → 监控资源状态 → 查看日志 → 配置告警             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  7. 回滚和故障处理（如需要）                    │
│                                                               │
│  回滚部署 → 故障排查 → 手动干预                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 关键概念总结

### 1. 组织层级
```
组织 (Organization)
  ├── 团队 (Team)
  │   └── 成员 (Member)
  └── 项目 (Project)
      ├── 仓库 (Repository)
      ├── 环境 (Environment)
      ├── Pipeline
      └── 部署 (Deployment)
```

### 2. GitOps 工作流
```
开发者修改代码/配置
  ↓
Git Commit & Push
  ↓
Flux 检测变更（定期轮询）
  ↓
Flux 应用到 Kubernetes
  ↓
Kubernetes 创建/更新资源
  ↓
应用运行
```

### 3. 部署方式对比

| 方式 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| GitOps UI | 简单易用，可视化 | 需要 UI 操作 | 快速部署，不熟悉 YAML |
| GitOps Git | 代码审查，版本控制 | 需要熟悉 Git | 生产环境，团队协作 |
| Pipeline | 自动化，CI/CD 集成 | 配置复杂 | 持续集成，自动化测试 |
| 手动部署 | 灵活，快速 | 不可追溯 | 临时测试，紧急修复 |

### 4. 环境配置建议

| 环境 | Git 分支 | 自动同步 | 审批 | 同步间隔 |
|------|----------|----------|------|----------|
| 开发 | develop | ✓ | ✗ | 1m |
| 测试 | staging | ✓ | ✗ | 5m |
| 生产 | main | ✗ | ✓ | 10m |

---

## 最佳实践

1. **使用 GitOps 进行生产部署** - 所有变更都有记录，可追溯
2. **不同环境使用不同分支** - 隔离配置，避免误操作
3. **生产环境禁用自动同步** - 手动触发，更安全
4. **启用审批流程** - 生产部署需要多人审批
5. **配置健康检查** - 确保应用正常运行
6. **设置资源限制** - 避免资源耗尽
7. **定期查看审计日志** - 追踪所有操作
8. **配置告警规则** - 及时发现问题

---

## 常见问题

### Q: 必须使用 GitOps 吗？
A: 不是必须的。GitOps 是可选功能，你可以使用传统的手动部署或 Pipeline 部署。

### Q: GitOps 和 Pipeline 有什么区别？
A: 
- GitOps: 声明式，Git 是唯一的真实来源，Flux 自动同步
- Pipeline: 命令式，通过 CI/CD 流程执行部署命令

### Q: 如何选择部署方式？
A:
- 快速迭代：GitOps UI
- 生产部署：GitOps Git（代码审查）
- 自动化测试：Pipeline
- 临时测试：手动部署

### Q: Flux 同步延迟多久？
A: 取决于配置的同步间隔（syncInterval），通常 1-10 分钟。可以手动触发立即同步。

### Q: 如何回滚部署？
A: 在部署历史中找到目标版本，点击回滚按钮。系统会自动创建回滚 Commit 并应用。

---

## 下一步

- 查看 [GitOps 快速入门](./gitops/QUICK_START.md)
- 查看 [API 参考文档](./api/gitops/API_REFERENCE.md)
- 查看 [故障排查指南](./gitops/TROUBLESHOOTING.md)
