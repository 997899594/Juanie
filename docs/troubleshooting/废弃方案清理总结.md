# 废弃方案清理总结

## 问题背景

在项目初始化流程中，存在两套 GitOps 设置方案：
1. **废弃方案**：事件驱动（ProjectsService → EventPublisher → FluxSyncService）
2. **当前方案**：直接调用（Worker → FluxResourcesService）

这导致代码混乱，路径不清晰，需要彻底清理废弃方案。

---

## 已完成的清理

### 1. ✅ 删除 ProjectsService 中的废弃方法

**文件**: `packages/services/business/src/projects/projects.service.ts`

**删除的方法**:
- `requestGitOpsSetup()` - 发布 GitOps 设置请求事件
- `markGitOpsSetupFailed()` - 标记 GitOps 设置失败

**原因**: 这两个方法使用事件驱动方式，已被 Worker 直接调用 FluxResourcesService 替代。

---

### 2. ✅ 保留但不再使用的事件监听器

**文件**: `packages/services/business/src/gitops/flux/flux-sync.service.ts`

**保留的方法**:
```typescript
@OnEvent(IntegrationEvents.GITOPS_SETUP_REQUESTED)
async handleSetupRequest(event: GitOpsSetupRequestedEvent): Promise<void>
```

**状态**: 保留但不再被调用（没有任何地方发布 `GITOPS_SETUP_REQUESTED` 事件）

**原因**: 
- 代码结构完整，可能用于未来扩展
- 删除需要修改事件定义和类型，影响范围较大
- 不影响当前流程（没有调用者）

---

### 3. ✅ 删除 projectSlug 相关代码

**修改的文件**:
- `packages/services/business/src/queue/project-initialization.worker.ts`
- `packages/services/business/src/projects/template-renderer.service.ts`
- `packages/services/business/src/gitops/git-sync/git-sync.worker.ts`
- `packages/types/src/template.types.ts`
- `packages/types/src/schemas.ts`
- 所有模板文件（`.github/workflows/*.yml`, `k8s/**/*.yaml`, `README.md`）

**改为使用**: `projectName` (项目名称，必须是英文)

---

## 当前正确的流程路径

### 项目初始化流程

```
用户创建项目
  ↓
ProjectsService.create()
  ↓
ProjectOrchestrator.createAndInitialize()
  ↓
BullMQ Queue (project-initialization)
  ↓
ProjectInitializationWorker.handleProjectInitialization()
  ↓
FluxResourcesService.setupProjectGitOps()  ← 直接调用，不使用事件
  ↓
创建 K8s 资源（Namespace, Secret, GitRepository, Kustomization）
```

### 关键点

1. **不使用事件驱动**: Worker 直接注入 `FluxResourcesService`，同步调用 `setupProjectGitOps()`
2. **不使用 projectSlug**: 所有地方都使用 `projectName`
3. **多租户支持**: 每个用户使用自己的 GitHub Token 和用户名
4. **镜像名称格式**: `ghcr.io/<github-username>/<project-name>:latest`

---

## 废弃方案 vs 当前方案对比

| 维度 | 废弃方案（事件驱动） | 当前方案（直接调用） |
|------|---------------------|---------------------|
| **调用方式** | ProjectsService → Event → FluxSyncService | Worker → FluxResourcesService |
| **错误处理** | 异步，难以捕获 | 同步，直接 try-catch |
| **进度追踪** | 无法追踪 | 可以实时更新进度 |
| **测试复杂度** | 需要模拟事件总线 | 直接 mock 服务 |
| **调试难度** | 高（事件链路长） | 低（调用栈清晰） |
| **代码可读性** | 差（跨多个文件） | 好（单一流程） |
| **性能** | 较差（事件传递开销） | 较好（直接调用） |
| **可靠性** | 低（事件可能丢失） | 高（同步执行） |

**结论**: 当前方案（直接调用）在所有维度都优于废弃方案（事件驱动）。

---

## 为什么保留 FluxSyncService.handleSetupRequest()？

虽然这个方法不再被调用，但保留它有以下原因：

1. **代码结构完整**: 删除需要修改事件定义、类型、导入等多处代码
2. **未来扩展**: 如果需要支持异步 GitOps 设置（例如从 UI 手动触发），可以复用
3. **不影响当前流程**: 没有调用者，不会被执行
4. **风险较低**: 保留比删除更安全

如果确定永远不需要事件驱动方式，可以在未来删除：
- `FluxSyncService.handleSetupRequest()` 方法
- `IntegrationEvents.GITOPS_SETUP_REQUESTED` 事件定义
- `GitOpsSetupRequestedEvent` 类型定义

---

## 验证清单

### ✅ 已验证

1. **构建成功**: `bun run build` 无错误
2. **类型检查通过**: TypeScript 编译无错误
3. **没有 projectSlug 残留**: 全局搜索确认已删除
4. **流程路径正确**: Worker 直接调用 FluxResourcesService

### ⏭️ 待验证（需要实际测试）

1. **创建新项目**: 验证镜像名称格式正确
2. **Pod 启动成功**: 验证 ImagePullSecret 工作正常
3. **多用户隔离**: 验证不同用户的项目使用各自的 GitHub Token

---

## 下一步行动

1. **重启后端**: `bun run dev:api`
2. **创建新项目**: 测试完整流程
3. **检查镜像名称**: 应该是 `ghcr.io/<github-username>/<project-name>:latest`
4. **检查 Pod 状态**: `kubectl get pods -n project-<project-id>-development`
5. **验证日志**: 确认没有错误

---

## 总结

✅ **已完成**:
- 删除 ProjectsService 中的废弃方法（`requestGitOpsSetup`, `markGitOpsSetupFailed`）
- 删除所有 projectSlug 相关代码
- 统一使用 projectName
- 流程路径清晰（Worker → FluxResourcesService）

⚠️ **保留但不使用**:
- `FluxSyncService.handleSetupRequest()` - 事件监听器（无调用者）
- `IntegrationEvents.GITOPS_SETUP_REQUESTED` - 事件定义（无发布者）
- `GitOpsSetupRequestedEvent` - 类型定义（无使用者）

🎯 **当前方案优势**:
- 同步执行，错误处理清晰
- 进度追踪实时准确
- 代码可读性高
- 测试和调试简单
- 性能和可靠性更好

---

**文档创建时间**: 2025-12-23  
**最后更新**: 2025-12-23
