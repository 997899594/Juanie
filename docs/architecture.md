# ç³»ç»Ÿæ¶æ„è®¾è®¡

## ğŸ“ æ¶æ„æ¦‚è§ˆ

Juanie é‡‡ç”¨ç°ä»£åŒ–çš„å¾®æœåŠ¡æ¶æ„ï¼ŒåŸºäº Monorepo ç»„ç»‡ä»£ç ï¼Œä½¿ç”¨ tRPC å®ç°ç±»å‹å®‰å…¨çš„å‰åç«¯é€šä¿¡ã€‚

---

## ğŸ›ï¸ åˆ†å±‚æ¶æ„

### 1. å‰ç«¯å±‚ (Presentation Layer)

**æŠ€æœ¯æ ˆ**: Vue 3 + Vite + Pinia + shadcn-vue

```
apps/web/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ views/              # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ components/         # å¯å¤ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ composables/        # ç»„åˆå¼å‡½æ•°
â”‚   â”œâ”€â”€ stores/             # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ router/             # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ layouts/            # å¸ƒå±€ç»„ä»¶
â”‚   â””â”€â”€ lib/                # å·¥å…·åº“ (tRPC å®¢æˆ·ç«¯)
```

**èŒè´£**:
- ç”¨æˆ·ç•Œé¢æ¸²æŸ“
- ç”¨æˆ·äº¤äº’å¤„ç†
- çŠ¶æ€ç®¡ç†
- è·¯ç”±å¯¼èˆª
- tRPC å®¢æˆ·ç«¯è°ƒç”¨

**ç‰¹ç‚¹**:
- ç»„ä»¶åŒ–å¼€å‘
- å“åº”å¼è®¾è®¡
- ç±»å‹å®‰å…¨ (TypeScript)
- æ‡’åŠ è½½è·¯ç”±
- SSE å®æ—¶æ›´æ–°

---

### 2. API ç½‘å…³å±‚ (API Gateway Layer)

**æŠ€æœ¯æ ˆ**: NestJS + tRPC + Fastify

```
apps/api-gateway/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ routers/            # tRPC è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ trpc/               # tRPC é…ç½®å’Œé€‚é…å™¨
â”‚   â”œâ”€â”€ guards/             # è®¤è¯å®ˆå«
â”‚   â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶
â”‚   â””â”€â”€ app.module.ts       # ä¸»æ¨¡å—
```

**èŒè´£**:
- API è·¯ç”±ç®¡ç†
- è¯·æ±‚éªŒè¯å’Œè½¬æ¢
- è®¤è¯å’Œæˆæƒ
- é”™è¯¯å¤„ç†
- æ—¥å¿—è®°å½•
- é™æµå’Œç†”æ–­

**tRPC è·¯ç”±ç»“æ„**:
```typescript
trpc/
â”œâ”€â”€ auth.router.ts          # è®¤è¯ç›¸å…³
â”œâ”€â”€ projects.router.ts      # é¡¹ç›®ç®¡ç†
â”œâ”€â”€ deployments.router.ts   # éƒ¨ç½²ç®¡ç†
â”œâ”€â”€ pipelines.router.ts     # æµæ°´çº¿
â”œâ”€â”€ teams.router.ts         # å›¢é˜Ÿç®¡ç†
â”œâ”€â”€ organizations.router.ts # ç»„ç»‡ç®¡ç†
â”œâ”€â”€ repositories.router.ts  # ä»£ç ä»“åº“
â”œâ”€â”€ environments.router.ts  # ç¯å¢ƒç®¡ç†
â”œâ”€â”€ cost-tracking.router.ts # æˆæœ¬è¿½è¸ª
â”œâ”€â”€ ai-assistants.router.ts # AI åŠ©æ‰‹
â”œâ”€â”€ gitops.router.ts        # GitOps
â”œâ”€â”€ notifications.router.ts # é€šçŸ¥
â””â”€â”€ security-policies.router.ts # å®‰å…¨ç­–ç•¥
```

---

### 3. ä¸šåŠ¡æœåŠ¡å±‚ (Business Service Layer)

**æŠ€æœ¯æ ˆ**: NestJS Modules

```
packages/services/
â”œâ”€â”€ auth/                   # è®¤è¯æˆæƒæœåŠ¡
â”œâ”€â”€ projects/               # é¡¹ç›®ç®¡ç†æœåŠ¡
â”œâ”€â”€ deployments/            # éƒ¨ç½²ç®¡ç†æœåŠ¡
â”œâ”€â”€ pipelines/              # æµæ°´çº¿æœåŠ¡
â”œâ”€â”€ repositories/           # ä»£ç ä»“åº“æœåŠ¡
â”œâ”€â”€ teams/                  # å›¢é˜Ÿç®¡ç†æœåŠ¡
â”œâ”€â”€ organizations/          # ç»„ç»‡ç®¡ç†æœåŠ¡
â”œâ”€â”€ environments/           # ç¯å¢ƒç®¡ç†æœåŠ¡
â”œâ”€â”€ cost-tracking/          # æˆæœ¬è¿½è¸ªæœåŠ¡
â”œâ”€â”€ ai-assistants/          # AI åŠ©æ‰‹æœåŠ¡
â”œâ”€â”€ git-ops/                # GitOps æœåŠ¡
â”œâ”€â”€ flux/                   # Flux CD é›†æˆ
â”œâ”€â”€ k3s/                    # K3s é›†æˆ
â”œâ”€â”€ notifications/          # é€šçŸ¥æœåŠ¡
â”œâ”€â”€ security-policies/      # å®‰å…¨ç­–ç•¥æœåŠ¡
â”œâ”€â”€ storage/                # å¯¹è±¡å­˜å‚¨æœåŠ¡
â”œâ”€â”€ templates/              # é¡¹ç›®æ¨¡æ¿æœåŠ¡
â”œâ”€â”€ users/                  # ç”¨æˆ·ç®¡ç†æœåŠ¡
â”œâ”€â”€ audit-logs/             # å®¡è®¡æ—¥å¿—æœåŠ¡
â”œâ”€â”€ ollama/                 # Ollama AI é›†æˆ
â””â”€â”€ git-providers/          # Git æä¾›å•†é›†æˆ
```

**æœåŠ¡æ¨¡å¼**:
æ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„ NestJS æ¨¡å—ï¼ŒåŒ…å«ï¼š
- `*.service.ts` - ä¸šåŠ¡é€»è¾‘
- `*.module.ts` - æ¨¡å—å®šä¹‰
- `*.types.ts` - ç±»å‹å®šä¹‰

**æœåŠ¡é—´é€šä¿¡**:
- ç›´æ¥ä¾èµ–æ³¨å…¥ (åŒè¿›ç¨‹)
- äº‹ä»¶æ€»çº¿ (å¼‚æ­¥è§£è€¦)
- é˜Ÿåˆ—ä»»åŠ¡ (é•¿æ—¶é—´æ“ä½œ)

---

### 4. æ ¸å¿ƒå±‚ (Core Layer)

**æŠ€æœ¯æ ˆ**: Drizzle ORM + BullMQ + Redis

```
packages/core/
â”œâ”€â”€ database/               # æ•°æ®åº“å±‚
â”‚   â”œâ”€â”€ src/schemas/       # æ•°æ®åº“è¡¨å®šä¹‰
â”‚   â”œâ”€â”€ drizzle/           # è¿ç§»æ–‡ä»¶
â”‚   â””â”€â”€ module.ts          # æ•°æ®åº“æ¨¡å—
â”‚
â”œâ”€â”€ queue/                  # é˜Ÿåˆ—å±‚
â”‚   â”œâ”€â”€ src/workers/       # é˜Ÿåˆ—å·¥ä½œå™¨
â”‚   â”œâ”€â”€ src/jobs/          # ä»»åŠ¡å®šä¹‰
â”‚   â””â”€â”€ module.ts          # é˜Ÿåˆ—æ¨¡å—
â”‚
â”œâ”€â”€ sse/                    # å®æ—¶é€šä¿¡å±‚
â”‚   â”œâ”€â”€ src/sse.service.ts # SSE æœåŠ¡
â”‚   â”œâ”€â”€ src/event-bus.service.ts # äº‹ä»¶æ€»çº¿
â”‚   â””â”€â”€ module.ts          # SSE æ¨¡å—
â”‚
â”œâ”€â”€ types/                  # ç±»å‹å®šä¹‰
â”œâ”€â”€ tokens/                 # Token ç®¡ç†
â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â””â”€â”€ observability/          # å¯è§‚æµ‹æ€§
```

---

## ğŸ”„ æ•°æ®æµ

### 1. åŒæ­¥è¯·æ±‚æµç¨‹

```
ç”¨æˆ·æ“ä½œ
  â†“
Vue ç»„ä»¶
  â†“
tRPC å®¢æˆ·ç«¯ (ç±»å‹å®‰å…¨)
  â†“
API ç½‘å…³ (è®¤è¯ + éªŒè¯)
  â†“
tRPC è·¯ç”±
  â†“
ä¸šåŠ¡æœåŠ¡ (ä¸šåŠ¡é€»è¾‘)
  â†“
æ•°æ®åº“ (Drizzle ORM)
  â†“
è¿”å›å“åº” (ç±»å‹å®‰å…¨)
  â†“
æ›´æ–° UI
```

### 2. å¼‚æ­¥ä»»åŠ¡æµç¨‹

```
ç”¨æˆ·æ“ä½œ (å¦‚åˆ›å»ºé¡¹ç›®)
  â†“
API ç½‘å…³
  â†“
ä¸šåŠ¡æœåŠ¡
  â†“
æ·»åŠ é˜Ÿåˆ—ä»»åŠ¡ (BullMQ)
  â†“
ç«‹å³è¿”å›ä»»åŠ¡ ID
  â†“
åå° Worker å¤„ç†
  â†“
å‘é€ SSE äº‹ä»¶ (å®æ—¶æ›´æ–°)
  â†“
å‰ç«¯æ¥æ”¶äº‹ä»¶
  â†“
æ›´æ–° UI çŠ¶æ€
```

### 3. å®æ—¶é€šä¿¡æµç¨‹

```
åç«¯äº‹ä»¶å‘ç”Ÿ
  â†“
äº‹ä»¶æ€»çº¿ (EventBus)
  â†“
SSE æœåŠ¡
  â†“
æ¨é€åˆ°å®¢æˆ·ç«¯ (Server-Sent Events)
  â†“
å‰ç«¯ EventSource æ¥æ”¶
  â†“
æ›´æ–° UI (å“åº”å¼)
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- ç”¨æˆ·å’Œç»„ç»‡
users                    # ç”¨æˆ·è¡¨
organizations            # ç»„ç»‡è¡¨
organization_members     # ç»„ç»‡æˆå‘˜å…³ç³»
teams                    # å›¢é˜Ÿè¡¨
team_members             # å›¢é˜Ÿæˆå‘˜å…³ç³»

-- é¡¹ç›®ç®¡ç†
projects                 # é¡¹ç›®è¡¨
project_members          # é¡¹ç›®æˆå‘˜å…³ç³»
team_projects            # å›¢é˜Ÿé¡¹ç›®å…³ç³»
project_templates        # é¡¹ç›®æ¨¡æ¿
repositories             # ä»£ç ä»“åº“

-- éƒ¨ç½²å’Œç¯å¢ƒ
environments             # ç¯å¢ƒè¡¨
deployments              # éƒ¨ç½²è®°å½•
deployment_approvals     # éƒ¨ç½²å®¡æ‰¹
pipelines                # æµæ°´çº¿
pipeline_runs            # æµæ°´çº¿è¿è¡Œè®°å½•

-- GitOps
gitops_resources         # GitOps èµ„æº

-- ç›‘æ§å’Œæ—¥å¿—
audit_logs               # å®¡è®¡æ—¥å¿—
notifications            # é€šçŸ¥
incidents                # äº‹ä»¶
project_events           # é¡¹ç›®äº‹ä»¶

-- æˆæœ¬å’Œå®‰å…¨
cost_tracking            # æˆæœ¬è¿½è¸ª
security_policies        # å®‰å…¨ç­–ç•¥

-- AI å’Œè®¤è¯
ai_assistants            # AI åŠ©æ‰‹
oauth_accounts           # OAuth è´¦æˆ·
```

### å…³ç³»è®¾è®¡

```
Organization (1) â”€â”€â”€ (N) Projects
Organization (1) â”€â”€â”€ (N) Teams
Team (N) â”€â”€â”€ (N) Projects (team_projects)
Project (1) â”€â”€â”€ (N) Repositories
Project (1) â”€â”€â”€ (N) Environments
Project (1) â”€â”€â”€ (N) Deployments
Project (1) â”€â”€â”€ (N) Pipelines
User (N) â”€â”€â”€ (N) Organizations (organization_members)
User (N) â”€â”€â”€ (N) Teams (team_members)
User (N) â”€â”€â”€ (N) Projects (project_members)
```

---

## ğŸ” è®¤è¯å’Œæˆæƒ

### è®¤è¯æµç¨‹

```
1. ç”¨æˆ·ç™»å½•
   â”œâ”€â”€ ç”¨æˆ·åå¯†ç ç™»å½•
   â””â”€â”€ OAuth ç™»å½• (GitHub/GitLab)

2. ç”Ÿæˆ JWT Token
   â”œâ”€â”€ Access Token (15åˆ†é’Ÿ)
   â””â”€â”€ Refresh Token (7å¤©)

3. Token å­˜å‚¨
   â”œâ”€â”€ å‰ç«¯: LocalStorage
   â””â”€â”€ åç«¯: Redis (é»‘åå•)

4. è¯·æ±‚è®¤è¯
   â”œâ”€â”€ æºå¸¦ Bearer Token
   â”œâ”€â”€ JWT éªŒè¯
   â””â”€â”€ ç”¨æˆ·ä¿¡æ¯æ³¨å…¥
```

### æˆæƒæ¨¡å‹ (RBAC)

```
è§’è‰²å±‚çº§:
â”œâ”€â”€ Super Admin (è¶…çº§ç®¡ç†å‘˜)
â”œâ”€â”€ Organization Owner (ç»„ç»‡æ‰€æœ‰è€…)
â”œâ”€â”€ Organization Admin (ç»„ç»‡ç®¡ç†å‘˜)
â”œâ”€â”€ Team Lead (å›¢é˜Ÿè´Ÿè´£äºº)
â”œâ”€â”€ Developer (å¼€å‘è€…)
â””â”€â”€ Viewer (æŸ¥çœ‹è€…)

æƒé™çŸ©é˜µ:
- é¡¹ç›®ç®¡ç†: create, read, update, delete, archive
- éƒ¨ç½²ç®¡ç†: deploy, rollback, approve
- å›¢é˜Ÿç®¡ç†: invite, remove, update_role
- ç¯å¢ƒç®¡ç†: create, update, delete
- æˆæœ¬æŸ¥çœ‹: view_cost, export_report
```

---

## ğŸ“¡ å®æ—¶é€šä¿¡æ¶æ„

### SSE (Server-Sent Events)

```typescript
// äº‹ä»¶ç±»å‹
type EventType =
  | 'project.created'
  | 'project.updated'
  | 'deployment.started'
  | 'deployment.completed'
  | 'pipeline.running'
  | 'notification.new'

// äº‹ä»¶æµ
EventBus (å†…å­˜)
  â†“
SSE Service (è¿‡æ»¤ + æ ¼å¼åŒ–)
  â†“
HTTP Response Stream
  â†“
å®¢æˆ·ç«¯ EventSource
  â†“
Vue ç»„ä»¶æ›´æ–°
```

**ä¼˜åŠ¿**:
- å•å‘æ¨é€ï¼Œç®€å•é«˜æ•ˆ
- è‡ªåŠ¨é‡è¿
- åŸºäº HTTPï¼Œæ— éœ€é¢å¤–åè®®
- æ”¯æŒäº‹ä»¶ ID å’Œé‡æ”¾

---

## ğŸ”„ é˜Ÿåˆ—æ¶æ„

### BullMQ ä»»åŠ¡é˜Ÿåˆ—

```
é˜Ÿåˆ—ç±»å‹:
â”œâ”€â”€ project-initialization  # é¡¹ç›®åˆå§‹åŒ–
â”œâ”€â”€ repository-creation     # ä»“åº“åˆ›å»º
â”œâ”€â”€ deployment              # éƒ¨ç½²ä»»åŠ¡
â”œâ”€â”€ pipeline-execution      # æµæ°´çº¿æ‰§è¡Œ
â”œâ”€â”€ cost-calculation        # æˆæœ¬è®¡ç®—
â”œâ”€â”€ notification            # é€šçŸ¥å‘é€
â””â”€â”€ ai-analysis             # AI åˆ†æ
```

**Worker æ¨¡å¼**:
```typescript
// ä»»åŠ¡å®šä¹‰
interface Job {
  id: string
  type: string
  data: any
  priority: number
  attempts: number
  delay: number
}

// Worker å¤„ç†
Worker â†’ Process Job â†’ Update Status â†’ Emit Event
```

**ä»»åŠ¡çŠ¶æ€**:
- `waiting` - ç­‰å¾…å¤„ç†
- `active` - æ­£åœ¨å¤„ç†
- `completed` - å·²å®Œæˆ
- `failed` - å¤±è´¥
- `delayed` - å»¶è¿Ÿæ‰§è¡Œ

---

## ğŸš€ GitOps æ¶æ„

### Flux CD é›†æˆ

```
Git Repository (Source of Truth)
  â†“
Flux CD (ç›‘å¬å˜æ›´)
  â†“
K3s Cluster (åº”ç”¨å˜æ›´)
  â†“
åº”ç”¨éƒ¨ç½²
  â†“
çŠ¶æ€åŒæ­¥å› Git
```

**GitOps å·¥ä½œæµ**:
1. å¼€å‘è€…æ¨é€ä»£ç åˆ° Git
2. CI æ„å»ºé•œåƒ
3. æ›´æ–° GitOps ä»“åº“çš„ manifest
4. Flux æ£€æµ‹åˆ°å˜æ›´
5. è‡ªåŠ¨åº”ç”¨åˆ° K3s é›†ç¾¤
6. å¥åº·æ£€æŸ¥å’Œå›æ»š

---

## ğŸ“Š ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### OpenTelemetry é›†æˆ

```
åº”ç”¨ä»£ç 
  â†“
OpenTelemetry SDK
  â†“
Traces + Metrics + Logs
  â†“
Jaeger (åˆ†å¸ƒå¼è¿½è¸ª)
Prometheus (æŒ‡æ ‡æ”¶é›†)
Loki (æ—¥å¿—èšåˆ)
  â†“
Grafana (å¯è§†åŒ–)
```

**ç›‘æ§æŒ‡æ ‡**:
- API å“åº”æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- é˜Ÿåˆ—ä»»åŠ¡å¤„ç†æ—¶é—´
- é”™è¯¯ç‡å’ŒæˆåŠŸç‡
- èµ„æºä½¿ç”¨æƒ…å†µ

---

## ğŸ”§ æŠ€æœ¯å†³ç­–

### ä¸ºä»€ä¹ˆé€‰æ‹© tRPCï¼Ÿ
- âœ… ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨
- âœ… æ— éœ€æ‰‹å†™ API æ–‡æ¡£
- âœ… è‡ªåŠ¨ç±»å‹æ¨å¯¼
- âœ… ä¼˜ç§€çš„ DX (å¼€å‘ä½“éªŒ)
- âœ… è½»é‡çº§ï¼Œæ— é¢å¤–è¿è¡Œæ—¶

### ä¸ºä»€ä¹ˆé€‰æ‹© Drizzle ORMï¼Ÿ
- âœ… ç±»å‹å®‰å…¨çš„ SQL æŸ¥è¯¢
- âœ… é›¶è¿è¡Œæ—¶å¼€é”€
- âœ… ä¼˜ç§€çš„è¿ç§»å·¥å…·
- âœ… æ”¯æŒå…³ç³»æŸ¥è¯¢
- âœ… æ€§èƒ½ä¼˜å¼‚

### ä¸ºä»€ä¹ˆé€‰æ‹© BullMQï¼Ÿ
- âœ… åŸºäº Redisï¼Œé«˜æ€§èƒ½
- âœ… æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—
- âœ… ä»»åŠ¡é‡è¯•å’Œå»¶è¿Ÿ
- âœ… åˆ†å¸ƒå¼é”
- âœ… å¯è§†åŒ–ç›‘æ§

### ä¸ºä»€ä¹ˆé€‰æ‹© K3sï¼Ÿ
- âœ… è½»é‡çº§ Kubernetes
- âœ… æ˜“äºå®‰è£…å’Œç»´æŠ¤
- âœ… èµ„æºå ç”¨å°‘
- âœ… å®Œæ•´çš„ K8s API
- âœ… é€‚åˆè¾¹ç¼˜è®¡ç®—

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### å‰ç«¯ä¼˜åŒ–
- è·¯ç”±æ‡’åŠ è½½
- ç»„ä»¶æŒ‰éœ€åŠ è½½
- å›¾ç‰‡æ‡’åŠ è½½
- è™šæ‹Ÿæ»šåŠ¨ (å¤§åˆ—è¡¨)
- è¯·æ±‚å»é‡å’Œç¼“å­˜

### åç«¯ä¼˜åŒ–
- æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- æŸ¥è¯¢ç»“æœç¼“å­˜ (Redis)
- è¿æ¥æ± ç®¡ç†
- å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
- API å“åº”å‹ç¼©

### æ•°æ®åº“ä¼˜åŒ–
- åˆç†çš„ç´¢å¼•è®¾è®¡
- æŸ¥è¯¢ä¼˜åŒ– (EXPLAIN)
- è¯»å†™åˆ†ç¦» (æœªæ¥)
- åˆ†åº“åˆ†è¡¨ (æœªæ¥)

---

## ğŸ”® æœªæ¥è§„åˆ’

### çŸ­æœŸ (1-3 ä¸ªæœˆ)
- [ ] å®Œå–„ AI åŠ©æ‰‹åŠŸèƒ½
- [ ] å¢å¼ºç›‘æ§å’Œå‘Šè­¦
- [ ] ä¼˜åŒ–éƒ¨ç½²æµç¨‹
- [ ] æ·»åŠ æ›´å¤šé¡¹ç›®æ¨¡æ¿

### ä¸­æœŸ (3-6 ä¸ªæœˆ)
- [ ] å¤šé›†ç¾¤æ”¯æŒ
- [ ] é«˜å¯ç”¨æ¶æ„
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] ç§»åŠ¨ç«¯é€‚é…

### é•¿æœŸ (6-12 ä¸ªæœˆ)
- [ ] æ’ä»¶ç³»ç»Ÿ
- [ ] å¸‚åœºå’Œç”Ÿæ€
- [ ] ä¼ä¸šçº§åŠŸèƒ½
- [ ] å›½é™…åŒ–æ”¯æŒ

---

**æœ€åæ›´æ–°**: 2024-01-20  
**ç»´æŠ¤è€…**: Juanie Team
