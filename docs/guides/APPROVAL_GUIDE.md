# 部署审批流程指南

## 概述

部署审批流程用于控制生产环境的部署，确保变更经过审核后才能上线。本指南介绍如何配置和使用审批流程。

---

## 为什么需要审批流程

### 安全性

- 防止未经审核的代码部署到生产环境
- 减少人为错误导致的生产事故
- 确保变更符合公司政策和合规要求

### 可追溯性

- 记录谁批准了哪些部署
- 记录批准的时间和原因
- 便于事后审计和问题追踪

### 协作性

- 让团队成员了解即将发生的变更
- 提供讨论和反馈的机会
- 提高团队对生产环境的责任感

---

## 审批流程工作原理

### 基本流程

```
1. 开发者发起部署请求
   ↓
2. 系统检查是否需要审批
   ↓
3. 如果需要，创建审批请求
   ↓
4. 通知所有审批人
   ↓
5. 审批人审核并批准/拒绝
   ↓
6. 所有审批人批准后，自动执行部署
   ↓
7. 如果有人拒绝，部署失败
```

### 审批规则

**默认规则：**

| 环境类型 | 是否需要审批 | 审批人 | 最少审批数 |
|---------|------------|--------|-----------|
| Development | ❌ 否 | - | - |
| Staging | ❌ 否 | - | - |
| Production | ✅ 是 | 项目管理员 | 1 |

**自定义规则：**

您可以在项目设置中自定义审批规则：

```yaml
审批配置:
  production:
    enabled: true
    approvers:
      - role: admin        # 所有管理员
      - userId: user-123   # 特定用户
    minApprovals: 2        # 至少 2 人批准
    timeout: 24h           # 24 小时超时
    autoReject: true       # 超时自动拒绝
```

---

## 配置审批流程

### 步骤 1: 进入项目设置

1. 打开项目详情页面
2. 点击 **"设置"** Tab
3. 选择 **"审批规则"** 子菜单

### 步骤 2: 配置环境审批

为每个环境配置审批规则：

**生产环境示例：**

```
环境: Production

审批设置:
  ✅ 启用审批流程
  
审批人:
  ✅ 所有项目管理员
  ✅ 特定用户:
     - Alice (alice@example.com)
     - Bob (bob@example.com)
  
审批要求:
  最少审批数: 2
  超时时间: 24 小时
  超时后: 自动拒绝
  
通知设置:
  ✅ 邮件通知
  ✅ Slack 通知
  ❌ 短信通知
```

### 步骤 3: 保存配置

点击 **"保存"** 按钮应用配置。

---

## 发起部署审批

### 方式 1: 通过 UI 发起

1. 进入项目详情页面
2. 点击 **"部署"** Tab
3. 选择要部署的环境（如 Production）
4. 填写部署信息：

```
部署配置:
  环境: Production
  版本: v1.2.0
  Git 分支: main
  Git Commit: abc123
  
部署说明:
  本次部署包含以下变更:
  - 修复用户登录问题
  - 优化数据库查询性能
  - 更新依赖包版本
  
  测试情况:
  - ✅ 单元测试通过
  - ✅ 集成测试通过
  - ✅ 在 Staging 环境验证通过
```

5. 点击 **"提交审批"** 按钮

### 方式 2: 通过 Git 触发

推送代码到特定分支会自动触发部署审批：

```bash
# 推送到 main 分支触发生产环境部署审批
git push origin main

# 系统会自动:
# 1. 检测到 main 分支更新
# 2. 创建部署记录
# 3. 创建审批请求
# 4. 通知审批人
```

### 方式 3: 通过 API 发起

```bash
curl -X POST http://localhost:3000/api/trpc/deployments.create \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "projectId": "proj-456",
    "environmentId": "env-prod",
    "version": "v1.2.0",
    "gitBranch": "main",
    "gitCommit": "abc123",
    "description": "修复用户登录问题"
  }'
```

---

## 审批部署

### 查看待审批列表

**方式 1: 通过通知**

您会收到审批通知：

```
📧 邮件通知:
  主题: [需要审批] My React App 部署到 Production
  内容:
    项目: My React App
    环境: Production
    版本: v1.2.0
    申请人: Alice
    申请时间: 2025-11-13 10:00:00
    
    变更说明:
    - 修复用户登录问题
    - 优化数据库查询性能
    
    [批准] [拒绝] [查看详情]
```

**方式 2: 通过 UI**

1. 登录系统
2. 点击顶部导航栏的 **"待审批"** 图标（显示待审批数量）
3. 查看待审批列表

### 审批操作

#### 批准部署

1. 点击待审批项目
2. 查看部署详情：

```
部署信息:
  项目: My React App
  环境: Production
  版本: v1.2.0
  Git Commit: abc123
  申请人: Alice
  申请时间: 2025-11-13 10:00:00
  
变更说明:
  - 修复用户登录问题
  - 优化数据库查询性能
  - 更新依赖包版本
  
测试情况:
  ✅ 单元测试通过 (100%)
  ✅ 集成测试通过 (95%)
  ✅ Staging 环境验证通过
  
代码审查:
  ✅ 2 人已审查
  ✅ 无阻塞性问题
  
审批状态:
  已批准: 0 / 2
  待审批: Bob, Charlie
```

3. 填写审批意见（可选）：

```
审批意见:
  变更合理，测试充分，同意部署。
  建议在部署后监控用户登录成功率。
```

4. 点击 **"批准"** 按钮

#### 拒绝部署

1. 点击待审批项目
2. 查看部署详情
3. 填写拒绝原因（必填）：

```
拒绝原因:
  测试覆盖率不足，建议补充以下测试:
  1. 用户登录失败场景的测试
  2. 数据库连接失败的测试
  3. 并发登录的压力测试
  
  请在 Staging 环境完成测试后重新提交。
```

4. 点击 **"拒绝"** 按钮

### 审批结果

#### 全部批准

当所有审批人都批准后：

```
✅ 审批通过

审批记录:
  Bob: 批准 (2025-11-13 10:15:00)
    意见: 变更合理，同意部署
    
  Charlie: 批准 (2025-11-13 10:20:00)
    意见: LGTM

部署状态: 正在部署...
预计完成时间: 2025-11-13 10:25:00
```

系统会自动执行部署。

#### 有人拒绝

当任何一个审批人拒绝后：

```
❌ 审批被拒绝

拒绝记录:
  Bob: 拒绝 (2025-11-13 10:15:00)
    原因: 测试覆盖率不足

部署状态: 已取消
建议: 根据反馈修改后重新提交
```

部署会被取消，申请人会收到通知。

#### 审批超时

如果在规定时间内未完成审批：

```
⏰ 审批超时

审批记录:
  Bob: 批准 (2025-11-13 10:15:00)
  Charlie: 未响应 (超时)

部署状态: 已取消
原因: 审批超时（24 小时未响应）
建议: 重新提交审批请求
```

---

## 审批历史

### 查看审批历史

在项目详情页面的 **"审计日志"** Tab 中，可以查看所有审批历史：

```
审批历史:

2025-11-13 10:20:00 - 部署审批通过
  项目: My React App
  环境: Production
  版本: v1.2.0
  申请人: Alice
  审批人: Bob, Charlie
  结果: 批准
  
2025-11-12 15:30:00 - 部署审批被拒绝
  项目: My React App
  环境: Production
  版本: v1.1.9
  申请人: Alice
  审批人: Bob
  结果: 拒绝
  原因: 测试不充分
  
2025-11-11 09:00:00 - 部署审批通过
  项目: My React App
  环境: Production
  版本: v1.1.8
  申请人: Bob
  审批人: Alice, Charlie
  结果: 批准
```

### 导出审批记录

点击 **"导出"** 按钮，可以导出审批记录为 CSV 或 PDF 格式，用于审计和合规检查。

---

## 最佳实践

### 1. 审批人配置

**推荐配置：**

```yaml
审批人:
  - 至少 2 名项目管理员
  - 包含技术负责人
  - 包含运维负责人（如果有）
  
最少审批数:
  - 小型项目: 1 人
  - 中型项目: 2 人
  - 大型项目: 3 人
```

**注意事项：**
- 避免单点审批（至少 2 人）
- 审批人应该熟悉项目
- 审批人应该有足够的权限

### 2. 审批时效

**推荐配置：**

```yaml
超时时间:
  - 紧急修复: 2 小时
  - 常规部署: 24 小时
  - 大版本发布: 48 小时
  
超时后:
  - 自动拒绝（推荐）
  - 或通知管理员手动处理
```

**注意事项：**
- 设置合理的超时时间
- 避免审批流程阻塞部署
- 紧急情况可以绕过审批（需要记录）

### 3. 审批信息

**推荐填写：**

```yaml
部署说明:
  - 变更内容（What）
  - 变更原因（Why）
  - 测试情况（How）
  - 风险评估（Risk）
  - 回滚计划（Rollback）
  
审批意见:
  - 审查结果
  - 发现的问题
  - 改进建议
  - 监控重点
```

**注意事项：**
- 提供充分的信息帮助审批人决策
- 记录审批意见便于事后追溯
- 使用清晰的语言，避免歧义

### 4. 紧急部署

**紧急情况处理：**

```yaml
紧急部署流程:
  1. 评估紧急程度
  2. 通知审批人（电话/Slack）
  3. 快速审批（15 分钟内）
  4. 部署后补充文档
  5. 事后复盘
  
绕过审批:
  - 仅限 P0 级别故障
  - 需要 CTO/VP 批准
  - 必须记录到审计日志
  - 24 小时内补充审批
```

**注意事项：**
- 明确紧急情况的定义
- 建立快速响应机制
- 事后必须补充文档和复盘

### 5. 审批通知

**推荐配置：**

```yaml
通知渠道:
  - 邮件（必须）
  - Slack/钉钉（推荐）
  - 短信（紧急情况）
  
通知时机:
  - 审批请求创建时
  - 审批状态变更时
  - 审批即将超时时（提前 2 小时）
  - 审批超时时
```

**注意事项：**
- 确保审批人能及时收到通知
- 避免通知过于频繁
- 提供快捷审批链接

---

## 常见问题

### Q1: 如何临时禁用审批流程？

**A:** 在项目设置中，可以临时禁用审批：

```
审批设置:
  ❌ 启用审批流程（临时禁用）
  
禁用原因: 紧急修复生产故障
禁用时间: 2025-11-13 10:00 - 12:00
禁用人: Alice
```

**注意：** 禁用审批会记录到审计日志。

### Q2: 审批人不在怎么办？

**A:** 有几种处理方式：

1. **配置备用审批人**
   ```yaml
   审批人:
     - Alice (主要)
     - Bob (备用)
   ```

2. **配置审批人组**
   ```yaml
   审批人组:
     - 任意管理员（至少 2 人）
   ```

3. **联系管理员手动处理**

### Q3: 如何撤回审批请求？

**A:** 在审批完成前，申请人可以撤回：

1. 进入 **"部署"** Tab
2. 找到待审批的部署
3. 点击 **"撤回"** 按钮
4. 填写撤回原因

### Q4: 审批被拒绝后如何重新提交？

**A:** 根据拒绝原因修改后，重新发起部署请求：

1. 修复拒绝原因中提到的问题
2. 在 Staging 环境验证
3. 重新提交部署请求
4. 在部署说明中说明已修复的问题

### Q5: 如何查看某个人的审批记录？

**A:** 在 **"审计日志"** 中，可以按审批人筛选：

```
筛选条件:
  操作类型: 部署审批
  操作人: Bob
  时间范围: 最近 30 天
```

---

## 审批流程图

```
┌─────────────────┐
│  发起部署请求    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 检查是否需要审批 │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  需要      不需要
    │         │
    │         ▼
    │    ┌─────────┐
    │    │ 直接部署 │
    │    └─────────┘
    │
    ▼
┌─────────────────┐
│  创建审批请求    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  通知审批人      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  等待审批        │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  批准      拒绝
    │         │
    │         ▼
    │    ┌─────────┐
    │    │ 部署失败 │
    │    └─────────┘
    │
    ▼
┌─────────────────┐
│ 检查是否全部批准 │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  全部      部分
  批准      批准
    │         │
    │         ▼
    │    ┌─────────┐
    │    │ 继续等待 │
    │    └─────────┘
    │
    ▼
┌─────────────────┐
│  执行部署        │
└─────────────────┘
```

---

## 相关文档

- [项目创建指南](./PROJECT_CREATION_GUIDE.md)
- [部署指南](./DEPLOYMENT_GUIDE.md)
- [审计日志说明](./AUDIT_LOG_GUIDE.md)
- [权限管理指南](./PERMISSION_GUIDE.md)
