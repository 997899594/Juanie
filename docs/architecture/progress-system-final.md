# é¡¹ç›®åˆå§‹åŒ–è¿›åº¦ç³»ç»Ÿ - æœ€ç»ˆæ–¹æ¡ˆ

## æ¦‚è¿°

é¡¹ç›®åˆå§‹åŒ–è¿›åº¦ç³»ç»Ÿè´Ÿè´£è·Ÿè¸ªå’Œå±•ç¤ºé¡¹ç›®åˆ›å»ºè¿‡ç¨‹ä¸­çš„å®æ—¶è¿›åº¦ã€‚ç³»ç»Ÿè®¾è®¡éµå¾ª**å•ä¸€æ•°æ®æº**åŸåˆ™ï¼Œç¡®ä¿è¿›åº¦**å•è°ƒé€’å¢**ï¼Œæ°¸ä¸å›é€€ã€‚

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒåŸåˆ™

1. **å•ä¸€æ•°æ®æº**ï¼šRedis æ˜¯å®æ—¶è¿›åº¦çš„å”¯ä¸€æ¥æº
2. **å•è°ƒæ€§ä¿è¯**ï¼šè¿›åº¦åªèƒ½å¢åŠ ï¼Œä¸èƒ½å›é€€
3. **äº‹ä»¶é©±åŠ¨**ï¼šé€šè¿‡ Redis Pub/Sub + SSE å®æ—¶é€šçŸ¥å‰ç«¯
4. **èŒè´£åˆ†ç¦»**ï¼šåç«¯è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œå‰ç«¯åªè´Ÿè´£å±•ç¤º

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (Vue)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  InitializationProgress.vue                          â”‚   â”‚
â”‚  â”‚  - ç›‘å¬ SSE äº‹ä»¶                                      â”‚   â”‚
â”‚  â”‚  - å±•ç¤ºè¿›åº¦æ¡                                         â”‚   â”‚
â”‚  â”‚  - å®Œå…¨ä¿¡ä»»åç«¯æ•°æ®                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†‘                                  â”‚
â”‚                           â”‚ SSE Events                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ (NestJS)                             â”‚
â”‚                           â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  tRPC Router (projects.router.ts)                     â”‚  â”‚
â”‚  â”‚  - onInitProgress: SSE è®¢é˜…                           â”‚  â”‚
â”‚  â”‚  - getStatus: è·å–é¡¹ç›®çŠ¶æ€                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ProjectStatusService                                  â”‚  â”‚
â”‚  â”‚  - è·å–é¡¹ç›®çŠ¶æ€                                        â”‚  â”‚
â”‚  â”‚  - å¦‚æœæ­£åœ¨åˆå§‹åŒ–ï¼Œä» Redis è·å–å®æ—¶è¿›åº¦              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ProgressManagerService (æ ¸å¿ƒ)                         â”‚  â”‚
â”‚  â”‚  - updateProgress(): æ›´æ–°è¿›åº¦ + å•è°ƒæ€§æ£€æŸ¥            â”‚  â”‚
â”‚  â”‚  - getCurrentProgress(): è·å–å½“å‰è¿›åº¦                 â”‚  â”‚
â”‚  â”‚  - getProgressInfo(): è·å–å®Œæ•´è¿›åº¦ä¿¡æ¯                â”‚  â”‚
â”‚  â”‚  - markCompleted(): æ ‡è®°å®Œæˆ                          â”‚  â”‚
â”‚  â”‚  - markFailed(): æ ‡è®°å¤±è´¥                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ProjectInitializationWorker                           â”‚  â”‚
â”‚  â”‚  - æ‰§è¡Œåˆå§‹åŒ–æ­¥éª¤                                      â”‚  â”‚
â”‚  â”‚  - è°ƒç”¨ ProgressManager æ›´æ–°è¿›åº¦                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Redis                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Key: project:{id}:progress                           â”‚  â”‚
â”‚  â”‚  Value: { progress, message, timestamp }              â”‚  â”‚
â”‚  â”‚  TTL: 1 hour                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Channel: project:progress                             â”‚  â”‚
â”‚  â”‚  Message: { projectId, progress, message }            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶

### 1. ProgressManagerService (åç«¯æ ¸å¿ƒ)

**ä½ç½®**ï¼š`packages/services/business/src/projects/initialization/progress-manager.service.ts`

**èŒè´£**ï¼š
- ç®¡ç†è¿›åº¦çš„å”¯ä¸€çœŸç›¸æºï¼ˆRedisï¼‰
- ä¿è¯è¿›åº¦å•è°ƒé€’å¢
- å‘å¸ƒè¿›åº¦äº‹ä»¶åˆ° Redis Pub/Sub
- æä¾›è¿›åº¦æŸ¥è¯¢æ¥å£

**å…³é”®æ–¹æ³•**ï¼š

```typescript
// æ›´æ–°è¿›åº¦ï¼ˆè‡ªåŠ¨ä¿è¯å•è°ƒæ€§ï¼‰
async updateProgress(projectId: string, progress: number, message: string): Promise<boolean>

// è·å–å½“å‰è¿›åº¦å€¼
async getCurrentProgress(projectId: string): Promise<number>

// è·å–å®Œæ•´è¿›åº¦ä¿¡æ¯
async getProgressInfo(projectId: string): Promise<{ progress: number; message: string; timestamp: number } | null>

// æ ‡è®°å®Œæˆ
async markCompleted(projectId: string): Promise<void>

// æ ‡è®°å¤±è´¥
async markFailed(projectId: string, error: string): Promise<void>
```

**å•è°ƒæ€§ä¿è¯**ï¼š

```typescript
async updateProgress(projectId: string, progress: number, message: string): Promise<boolean> {
  // 1. è·å–å½“å‰è¿›åº¦
  const currentProgress = await this.getCurrentProgress(projectId)

  // 2. æ£€æŸ¥å•è°ƒæ€§
  if (progress < currentProgress) {
    this.logger.warn(`ğŸš« Rejected progress regression for ${projectId}: ${progress}% < ${currentProgress}%`)
    return false
  }

  // 3. æ›´æ–° Redis
  const progressKey = `project:${projectId}:progress`
  await this.redis.set(progressKey, JSON.stringify({ progress, message, timestamp: Date.now() }), 'EX', 3600)

  // 4. å‘å¸ƒäº‹ä»¶
  await this.redis.publish('project:progress', JSON.stringify({ projectId, progress, message }))

  return true
}
```

### 2. ProjectStatusService (çŠ¶æ€æŸ¥è¯¢)

**ä½ç½®**ï¼š`packages/services/business/src/projects/project-status.service.ts`

**èŒè´£**ï¼š
- è·å–é¡¹ç›®å®Œæ•´çŠ¶æ€
- å¦‚æœé¡¹ç›®æ­£åœ¨åˆå§‹åŒ–ï¼Œä» Redis è·å–å®æ—¶è¿›åº¦

**å…³é”®é€»è¾‘**ï¼š

```typescript
async getStatus(projectId: string): Promise<ProjectStatus> {
  // è·å–é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  const [project] = await this.db.select().from(schema.projects).where(eq(schema.projects.id, projectId))

  // å¦‚æœé¡¹ç›®æ­£åœ¨åˆå§‹åŒ–ï¼Œä½¿ç”¨ Redis çš„å®æ—¶è¿›åº¦
  if (project.status === 'initializing') {
    const realtimeProgress = await this.progressManager.getProgressInfo(projectId)
    if (realtimeProgress) {
      project.initializationStatus = {
        step: realtimeProgress.message,
        progress: realtimeProgress.progress,
        completedSteps: project.initializationStatus?.completedSteps || [],
        error: project.initializationStatus?.error,
        jobId: project.initializationStatus?.jobId,
      }
    }
  }

  return { project, ... }
}
```

### 3. ProjectInitializationWorker (è¿›åº¦æ›´æ–°è€…)

**ä½ç½®**ï¼š`packages/services/business/src/queue/project-initialization.worker.ts`

**èŒè´£**ï¼š
- æ‰§è¡Œåˆå§‹åŒ–æ­¥éª¤
- é€šè¿‡ ProgressManager æ›´æ–°è¿›åº¦

**å…³é”®é€»è¾‘**ï¼š

```typescript
private async updateProgress(job: Job, progress: number, message: string) {
  const projectId = job.data.projectId
  if (!projectId) return

  // ä½¿ç”¨ ProgressManager æ›´æ–°è¿›åº¦ï¼ˆè‡ªåŠ¨ä¿è¯å•è°ƒæ€§ï¼‰
  const updated = await this.progressManager.updateProgress(projectId, progress, message)

  if (updated) {
    // åŒæ­¥æ›´æ–° BullMQ è¿›åº¦
    await job.updateProgress(progress)
    await job.log(`[${progress}%] ${message}`)
  }
}
```

### 4. InitializationProgress.vue (å‰ç«¯å±•ç¤º)

**ä½ç½®**ï¼š`apps/web/src/components/InitializationProgress.vue`

**èŒè´£**ï¼š
- ç›‘å¬ SSE äº‹ä»¶
- å±•ç¤ºè¿›åº¦æ¡å’ŒçŠ¶æ€
- å®Œå…¨ä¿¡ä»»åç«¯æ•°æ®

**å…³é”®é€»è¾‘**ï¼š

```typescript
// ä»åç«¯è·å–å½“å‰çŠ¶æ€ï¼ˆç”¨äºé¡µé¢åˆ·æ–°æ¢å¤ï¼‰
async function fetchCurrentStatus() {
  const projectStatus = await trpc.projects.getStatus.query({ projectId })
  
  if (project.status === 'initializing') {
    const initStatus = project.initializationStatus
    if (initStatus?.progress !== undefined) {
      progress.value = initStatus.progress
      currentMessage.value = initStatus.step || 'æ­£åœ¨åˆå§‹åŒ–...'
    }
  }
  
  // è¿æ¥ SSE ç›‘å¬åç»­è¿›åº¦
  connectSubscription()
}

// è¿æ¥ SSE è®¢é˜…ï¼ˆå”¯ä¸€çš„è¿›åº¦æ•°æ®æºï¼‰
function connectSubscription() {
  unsubscribe = trpc.projects.onInitProgress.subscribe(
    { projectId },
    {
      onData: (event) => {
        // è¿›åº¦æ›´æ–°ï¼ˆå®Œå…¨ä¿¡ä»»åç«¯ ProgressManagerï¼‰
        if (event.type === 'initialization.progress') {
          progress.value = event.data?.progress || 0
          currentMessage.value = event.data?.message || ''
        }
      }
    }
  )
}
```

## æ•°æ®æµ

### 1. åˆ›å»ºé¡¹ç›®æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"åˆ›å»ºé¡¹ç›®"
   â†“
2. å‰ç«¯è°ƒç”¨ createProject API
   â†“
3. åç«¯åˆ›å»ºé¡¹ç›®è®°å½•ï¼ˆstatus: 'initializing', progress: 0ï¼‰
   â†“
4. åç«¯å°†åˆå§‹åŒ–ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
   â†“
5. Worker å¼€å§‹æ‰§è¡Œåˆå§‹åŒ–æ­¥éª¤
   â†“
6. Worker è°ƒç”¨ ProgressManager.updateProgress()
   â”œâ”€ æ£€æŸ¥å•è°ƒæ€§
   â”œâ”€ æ›´æ–° Redis
   â””â”€ å‘å¸ƒ SSE äº‹ä»¶
   â†“
7. å‰ç«¯æ¥æ”¶ SSE äº‹ä»¶ï¼Œæ›´æ–°è¿›åº¦æ¡
   â†“
8. åˆå§‹åŒ–å®Œæˆï¼ŒWorker è°ƒç”¨ ProgressManager.markCompleted()
   â†“
9. å‰ç«¯æ˜¾ç¤º"åˆå§‹åŒ–å®Œæˆ"
```

### 2. é¡µé¢åˆ·æ–°æ¢å¤æµç¨‹

```
1. ç”¨æˆ·åˆ·æ–°é¡µé¢
   â†“
2. å‰ç«¯è°ƒç”¨ getStatus API
   â†“
3. ProjectStatusService æ£€æŸ¥é¡¹ç›®çŠ¶æ€
   â”œâ”€ å¦‚æœ status = 'initializing'
   â”‚  â””â”€ ä» Redis è·å–å®æ—¶è¿›åº¦
   â””â”€ è¿”å›æœ€æ–°è¿›åº¦
   â†“
4. å‰ç«¯æ¢å¤è¿›åº¦æ¡çŠ¶æ€
   â†“
5. å‰ç«¯è¿æ¥ SSEï¼Œç»§ç»­æ¥æ”¶åç»­è¿›åº¦
```

## è¿›åº¦å®šä¹‰

| è¿›åº¦ | æ­¥éª¤ | è¯´æ˜ |
|------|------|------|
| 0% | å¼€å§‹åˆå§‹åŒ– | åˆ›å»ºé¡¹ç›®è®°å½• |
| 20% | åˆ›å»ºæ•°æ®åº“è®°å½• | åˆ›å»ºç¯å¢ƒã€ä»“åº“ç­‰è®°å½• |
| 35% | åˆ›å»º Git ä»“åº“ | åœ¨ GitHub/GitLab åˆ›å»ºä»“åº“ |
| 50% | é…ç½® SSH å¯†é’¥ | åˆ›å»º Deploy Key æˆ– Access Token |
| 60% | åˆ›å»º Kubernetes èµ„æº | åˆ›å»º Namespaceã€Secret ç­‰ |
| 75% | é…ç½® Flux CD | åˆ›å»º GitRepository å’Œ Kustomization |
| 90% | ç­‰å¾…èµ„æºå°±ç»ª | ç­‰å¾… Flux åŒæ­¥å®Œæˆ |
| 95% | éªŒè¯éƒ¨ç½² | æ£€æŸ¥ Pod çŠ¶æ€ |
| 100% | åˆå§‹åŒ–å®Œæˆ | æ›´æ–°é¡¹ç›®çŠ¶æ€ä¸º 'active' |

## é”™è¯¯å¤„ç†

### åç«¯é”™è¯¯å¤„ç†

```typescript
try {
  await this.progressManager.updateProgress(projectId, 50, 'é…ç½® SSH å¯†é’¥')
  // æ‰§è¡Œæ­¥éª¤...
} catch (error) {
  await this.progressManager.markFailed(projectId, error.message)
  throw error
}
```

### å‰ç«¯é”™è¯¯å¤„ç†

```typescript
onData: (event) => {
  if (event.type === 'initialization.failed') {
    status.value = 'failed'
    errorMessage.value = event.data?.error || 'åˆå§‹åŒ–å¤±è´¥'
    emit('error', errorMessage.value)
  }
}
```

## æ€§èƒ½ä¼˜åŒ–

### Redis æ•°æ®è¿‡æœŸ

- è¿›åº¦æ•°æ® TTLï¼š1 å°æ—¶
- å®Œæˆåå»¶è¿Ÿæ¸…ç†ï¼š1 åˆ†é’Ÿï¼ˆç»™å‰ç«¯æ—¶é—´æ¥æ”¶æœ€åçš„äº‹ä»¶ï¼‰

### SSE è¿æ¥ç®¡ç†

- ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ–­å¼€è¿æ¥
- è¿æ¥é”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•ï¼ˆé€šè¿‡ fetchCurrentStatusï¼‰

### æ•°æ®åº“æ›´æ–°

- åªåœ¨å…³é”®èŠ‚ç‚¹æ›´æ–°æ•°æ®åº“ï¼ˆå¼€å§‹ã€å®Œæˆã€å¤±è´¥ï¼‰
- å®æ—¶è¿›åº¦åªå­˜å‚¨åœ¨ Redis

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
# æµ‹è¯• ProgressManager çš„å•è°ƒæ€§ä¿è¯
bun run scripts/test-progress-flow.ts
```

### é›†æˆæµ‹è¯•

```bash
# åˆ›å»ºé¡¹ç›®å¹¶è§‚å¯Ÿè¿›åº¦
bun run scripts/monitor-progress-events.ts
```

### æ‰‹åŠ¨æµ‹è¯•

1. åˆ›å»ºæ–°é¡¹ç›®
2. è§‚å¯Ÿè¿›åº¦æ¡å¹³æ»‘å¢é•¿ï¼ˆ0% â†’ 100%ï¼‰
3. åˆ·æ–°é¡µé¢ï¼Œè¿›åº¦æ¡åº”è¯¥æ¢å¤åˆ°å½“å‰è¿›åº¦
4. ä¸åº”è¯¥å‡ºç°è¿›åº¦å›é€€

## æ•…éšœæ’æŸ¥

### è¿›åº¦ä¸æ›´æ–°

1. æ£€æŸ¥ Redis è¿æ¥ï¼š`redis-cli ping`
2. æ£€æŸ¥ Worker æ˜¯å¦è¿è¡Œï¼š`bun run scripts/check-queue-jobs.ts`
3. æ£€æŸ¥åç«¯æ—¥å¿—ï¼šæŸ¥æ‰¾ `ProgressManager` çš„æ—¥å¿—

### è¿›åº¦å›é€€

1. æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ª Worker å®ä¾‹
2. æ£€æŸ¥ ProgressManager çš„æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ° `ğŸš« Rejected progress regression`
3. æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®è¿æ¥ SSE

### SSE è¿æ¥å¤±è´¥

1. æ£€æŸ¥ tRPC é…ç½®
2. æ£€æŸ¥ CORS è®¾ç½®
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

## æœªæ¥ä¼˜åŒ–

1. **è¿›åº¦æŒä¹…åŒ–**ï¼šå°†è¿›åº¦å®šæœŸåŒæ­¥åˆ°æ•°æ®åº“ï¼Œå‡å°‘å¯¹ Redis çš„ä¾èµ–
2. **è¿›åº¦é¢„æµ‹**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹å‰©ä½™æ—¶é—´
3. **å¹¶è¡Œæ­¥éª¤**ï¼šæ”¯æŒå¤šä¸ªæ­¥éª¤å¹¶è¡Œæ‰§è¡Œï¼ŒåŠ¨æ€è®¡ç®—æ€»è¿›åº¦
4. **æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒåˆå§‹åŒ–å¤±è´¥åä»æ–­ç‚¹ç»§ç»­

## ç›¸å…³æ–‡æ¡£

- [è¿›åº¦ç³»ç»Ÿé‡æ„è®°å½•](../troubleshooting/refactoring/progress-system-refactoring.md)
- [å‰ç«¯è¿›åº¦æ¡å›é€€é—®é¢˜](../troubleshooting/frontend/progress-bar-regression.md)
- [é¡¹ç›®åˆå§‹åŒ–çŠ¶æ€æœº](./state-machine.md)

## æ€»ç»“

æœ€ç»ˆçš„è¿›åº¦ç³»ç»Ÿå®ç°äº†ï¼š

âœ… **å•ä¸€æ•°æ®æº**ï¼šRedis æ˜¯å®æ—¶è¿›åº¦çš„å”¯ä¸€æ¥æº  
âœ… **å•è°ƒæ€§ä¿è¯**ï¼šProgressManager è‡ªåŠ¨æ‹’ç»è¿›åº¦å›é€€  
âœ… **å®æ—¶æ›´æ–°**ï¼šé€šè¿‡ Redis Pub/Sub + SSE å®æ—¶é€šçŸ¥å‰ç«¯  
âœ… **é¡µé¢åˆ·æ–°å‹å¥½**ï¼šåˆ·æ–°åèƒ½æ­£ç¡®æ¢å¤è¿›åº¦  
âœ… **èŒè´£åˆ†ç¦»**ï¼šåç«¯è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œå‰ç«¯åªè´Ÿè´£å±•ç¤º  
âœ… **é”™è¯¯å¤„ç†å®Œå–„**ï¼šæ”¯æŒå¤±è´¥é‡è¯•å’Œé”™è¯¯æç¤º  

ç³»ç»Ÿç®€æ´ã€å¯é ã€æ˜“ç»´æŠ¤ï¼Œå®Œå…¨è§£å†³äº†è¿›åº¦å›é€€é—®é¢˜ã€‚
