# UI åº“æ„å»ºå¡æ­»é—®é¢˜ - ç³»ç»Ÿè§£å†³æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### UI åº“çš„ç‰¹æ®Šæ€§

ä½ çš„ UI åº“æœ‰ **397 ä¸ªæ–‡ä»¶**ï¼ŒåŒ…æ‹¬ï¼š
- å¤§é‡ Vue ç»„ä»¶ï¼ˆ.vue æ–‡ä»¶ï¼‰
- TypeScript ç±»å‹å®šä¹‰
- æ ·å¼æ–‡ä»¶ï¼ˆCSSï¼‰
- ä¸»é¢˜ç³»ç»Ÿ
- ä½¿ç”¨ `preserveModules: true`ï¼ˆä¿ç•™æ¨¡å—ç»“æ„ï¼‰

### ä¸ºä»€ä¹ˆ UI åº“ç‰¹åˆ«å®¹æ˜“å¡æ­»ï¼Ÿ

1. **æ–‡ä»¶æ•°é‡å¤š**ï¼š397 ä¸ªæ–‡ä»¶éœ€è¦é€ä¸ªå¤„ç†
2. **vue-tsc ç±»å‹æ£€æŸ¥æ…¢**ï¼šVue ç»„ä»¶çš„ç±»å‹æ£€æŸ¥éå¸¸è€—æ—¶
3. **vite-plugin-dts**ï¼šç”Ÿæˆç±»å‹å£°æ˜æ–‡ä»¶ï¼Œéœ€è¦éå†æ‰€æœ‰æ–‡ä»¶
4. **preserveModules**ï¼šæ¯ä¸ªæ–‡ä»¶å•ç‹¬è¾“å‡ºï¼Œå¢åŠ  I/O æ“ä½œ
5. **Tailwind CSS**ï¼šéœ€è¦æ‰«ææ‰€æœ‰æ–‡ä»¶æå–æ ·å¼
6. **ä¾èµ–å¤æ‚**ï¼šradix-vue, reka-ui ç­‰å¤§å‹ä¾èµ–

### å¡æ­»çš„å…·ä½“ç¯èŠ‚

```
bun run build
  â†“
vue-tsc --noEmit  â† ğŸ”´ ç»å¸¸å¡åœ¨è¿™é‡Œï¼ˆç±»å‹æ£€æŸ¥ï¼‰
  â†“
vite build
  â†“
  â”œâ”€ æ‰«æå…¥å£æ–‡ä»¶
  â”œâ”€ è§£æä¾èµ–
  â”œâ”€ ç¼–è¯‘ Vue ç»„ä»¶  â† ğŸ”´ å¯èƒ½å¡åœ¨è¿™é‡Œ
  â”œâ”€ ç”Ÿæˆç±»å‹å£°æ˜  â† ğŸ”´ vite-plugin-dts å¡ä½
  â”œâ”€ å¤„ç† CSS
  â””â”€ è¾“å‡ºæ–‡ä»¶  â† ğŸ”´ preserveModules å¯¼è‡´å¤§é‡ I/O
```

## ç«‹å³è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨å¿«é€Ÿæ„å»ºï¼ˆè·³è¿‡ç±»å‹æ£€æŸ¥ï¼‰

```bash
cd packages/ui
bun run build:fast
```

è¿™ä¼šè·³è¿‡ `vue-tsc`ï¼Œç›´æ¥æ„å»ºï¼Œé€šå¸¸èƒ½æˆåŠŸã€‚

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ¸…ç†è„šæœ¬

```bash
# ä»æ ¹ç›®å½•
bun run ui:clean

# æˆ–è€…åœ¨ UI åŒ…ç›®å½•
cd packages/ui
./scripts/clean-build.sh
```

### æ–¹æ¡ˆ 3ï¼šåˆ†æ­¥æ„å»º

```bash
cd packages/ui

# 1. å…ˆåªåšç±»å‹æ£€æŸ¥ï¼ˆå¯èƒ½å¡ä½ï¼Œä½†å¯ä»¥ Ctrl+Cï¼‰
bun run type-check

# 2. è·³è¿‡ç±»å‹æ£€æŸ¥ç›´æ¥æ„å»º
bun run build:fast
```

## æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

### ä¼˜åŒ– 1ï¼šæ”¹è¿›æ„å»ºé…ç½®

æˆ‘å·²ç»ä¼˜åŒ–äº† `packages/ui/vite.config.ts`ï¼Œä½†è¿˜å¯ä»¥æ›´æ¿€è¿›ï¼š


```typescript
// packages/ui/vite.config.fast.ts
// å·²åˆ›å»º - è¶…å¿«é€Ÿæ„å»ºé…ç½®
// ç‰¹ç‚¹ï¼š
// - ç§»é™¤ vite-plugin-dtsï¼ˆä¸ç”Ÿæˆç±»å‹å£°æ˜ï¼‰
// - ç¦ç”¨ preserveModulesï¼ˆå•æ–‡ä»¶è¾“å‡ºï¼‰
// - ç¦ç”¨å‹ç¼©å’Œ sourcemap
// - é™ä½å¹¶å‘æ•°
```

### ä¼˜åŒ– 2ï¼šåˆ†ç¦»ç±»å‹ç”Ÿæˆ

ç±»å‹å£°æ˜ç”Ÿæˆï¼ˆvite-plugin-dtsï¼‰æ˜¯æœ€å®¹æ˜“å¡ä½çš„ç¯èŠ‚ã€‚

**æ–¹æ¡ˆï¼šå…ˆæ„å»º JSï¼Œå†ç”Ÿæˆç±»å‹**

```bash
# 1. ä½¿ç”¨è¶…å¿«é…ç½®æ„å»ºï¼ˆä¸ç”Ÿæˆç±»å‹ï¼‰
cd packages/ui
bun run build:ultra-fast

# 2. å•ç‹¬ç”Ÿæˆç±»å‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
bun run build:types-only
```

### ä¼˜åŒ– 3ï¼šä½¿ç”¨æ„å»ºç›‘æ§è„šæœ¬

```bash
cd packages/ui
./scripts/build-with-timeout.sh build:fast
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- è®¾ç½® 5 åˆ†é’Ÿè¶…æ—¶
- è‡ªåŠ¨æ¸…ç†ç¼“å­˜
- ç›‘æ§æ„å»ºè¿›ç¨‹
- è¶…æ—¶åè‡ªåŠ¨ç»ˆæ­¢å¹¶æç¤º

## æ„å»ºç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | å‘½ä»¤ | é€Ÿåº¦ | Tree-shaking | ç±»å‹å£°æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|------|--------------|----------|----------|
| å®Œæ•´æ„å»º | `bun run build` | ğŸŒ æ…¢ | âœ… æœ€å¥½ | âœ… æœ‰ | å‘å¸ƒç”Ÿäº§ |
| å¿«é€Ÿæ„å»º | `bun run build:fast` | ğŸš€ å¿« | âœ… å¥½ | âœ… æœ‰ | æ—¥å¸¸å¼€å‘ |
| è¶…å¿«æ„å»º | `bun run build:ultra-fast` | âš¡ è¶…å¿« | âš ï¸ ä¸€èˆ¬ | âŒ æ—  | ç´§æ€¥ä¿®å¤ |
| å¸¦è¶…æ—¶ | `./scripts/build-with-timeout.sh` | ğŸš€ å¿« | âœ… å¥½ | âœ… æœ‰ | è‡ªåŠ¨åŒ– |

## æ·±åº¦åˆ†æï¼šä¸ºä»€ä¹ˆå¡åœ¨ç‰¹å®šç¯èŠ‚ï¼Ÿ

### 1. vue-tsc å¡ä½

**åŸå› ï¼š**
- 397 ä¸ªæ–‡ä»¶éœ€è¦ç±»å‹æ£€æŸ¥
- Vue ç»„ä»¶çš„ç±»å‹æ¨å¯¼å¤æ‚
- ä¾èµ–çš„ç±»å‹å®šä¹‰æ–‡ä»¶å¤š

**è¡¨ç°ï¼š**
```bash
$ vue-tsc --noEmit
# å¡ä½ï¼Œæ²¡æœ‰ä»»ä½•è¾“å‡º
```

**è§£å†³ï¼š**
```bash
# æ–¹æ¡ˆ Aï¼šè·³è¿‡ç±»å‹æ£€æŸ¥
bun run build:fast

# æ–¹æ¡ˆ Bï¼šå¢åŠ å†…å­˜
NODE_OPTIONS="--max-old-space-size=8192" bun run build

# æ–¹æ¡ˆ Cï¼šä½¿ç”¨å¢é‡ç¼–è¯‘
# åœ¨ tsconfig.json ä¸­è®¾ç½® "incremental": true
```

### 2. vite-plugin-dts å¡ä½

**åŸå› ï¼š**
- éœ€è¦éå†æ‰€æœ‰æ–‡ä»¶ç”Ÿæˆ .d.ts
- rollupTypes ä¼šåˆå¹¶ç±»å‹ï¼Œéå¸¸è€—æ—¶
- å¤§å‹ä¾èµ–çš„ç±»å‹è§£ææ…¢

**è¡¨ç°ï¼š**
```bash
$ vite build
vite v7.1.9 building for production...
transforming...
# å¡åœ¨è¿™é‡Œ
```

**è§£å†³ï¼š**
```bash
# ä½¿ç”¨ä¸ç”Ÿæˆç±»å‹çš„é…ç½®
bun run build:ultra-fast
```

### 3. Rollup è¾“å‡ºé˜¶æ®µå¡ä½

**åŸå› ï¼š**
- `preserveModules: true` å¯¼è‡´å¤§é‡æ–‡ä»¶ I/O
- 397 ä¸ªæºæ–‡ä»¶ â†’ 397+ ä¸ªè¾“å‡ºæ–‡ä»¶
- macOS æ–‡ä»¶ç³»ç»Ÿå¯èƒ½å˜æ…¢

**è¡¨ç°ï¼š**
```bash
$ vite build
âœ“ 1234 modules transformed.
rendering chunks...
# å¡åœ¨è¿™é‡Œ
```

**è§£å†³ï¼š**
```bash
# ä½¿ç”¨å•æ–‡ä»¶è¾“å‡º
bun run build:ultra-fast
```

### 4. esbuild è¿›ç¨‹åƒµæ­»

**åŸå› ï¼š**
- esbuild æ˜¯ Go ç¨‹åºï¼Œæœ‰æ—¶ä¼šå¡ä½
- å¤„ç†å¤§é‡ä¾èµ–æ—¶å¯èƒ½æ­»é”

**è¡¨ç°ï¼š**
- è¿›ç¨‹å­˜åœ¨ä½† CPU å ç”¨ 0%
- æ²¡æœ‰ä»»ä½•è¾“å‡º

**è§£å†³ï¼š**
```bash
# å¼ºåˆ¶æ€æ­» esbuild
pkill -9 esbuild

# æ¸…ç†ç¼“å­˜
rm -rf node_modules/.vite

# é‡æ–°æ„å»º
bun run build:fast
```

## å®æˆ˜ï¼šæ„å»ºå¡ä½æ—¶çš„è¯Šæ–­æµç¨‹

### æ­¥éª¤ 1ï¼šç¡®å®šå¡åœ¨å“ªä¸ªç¯èŠ‚

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œ
watch -n 1 'ps aux | grep -E "(vite|esbuild|vue-tsc|node)" | grep -v grep'
```

è§‚å¯Ÿï¼š
- å¦‚æœçœ‹åˆ° `vue-tsc` â†’ å¡åœ¨ç±»å‹æ£€æŸ¥
- å¦‚æœçœ‹åˆ° `esbuild` â†’ å¡åœ¨ä¾èµ–é¢„æ„å»º
- å¦‚æœçœ‹åˆ° `node.*vite` â†’ å¡åœ¨ Vite æ„å»º

### æ­¥éª¤ 2ï¼šæ£€æŸ¥èµ„æºä½¿ç”¨

```bash
# æ£€æŸ¥å†…å­˜
vm_stat | perl -ne '/page size of (\d+)/ and $size=$1; /Pages\s+([^:]+)[^\d]+(\d+)/ and printf("%-16s % 16.2f Mi\n", "$1:", $2 * $size / 1048576);'

# æ£€æŸ¥ç£ç›˜ I/O
iostat -w 1
```

å¦‚æœå†…å­˜ä¸è¶³æˆ– I/O å¾ˆé«˜ï¼Œè¯´æ˜èµ„æºè€—å°½ã€‚

### æ­¥éª¤ 3ï¼šä½¿ç”¨è¶…æ—¶æ„å»º

```bash
cd packages/ui
./scripts/build-with-timeout.sh build:fast
```

å¦‚æœè¶…æ—¶ï¼Œè¯´æ˜ç¡®å®å¡ä½äº†ã€‚

### æ­¥éª¤ 4ï¼šå°è¯•ä¸åŒçš„æ„å»ºç­–ç•¥

```bash
# 1. æœ€å¿«çš„æ–¹å¼
bun run build:ultra-fast

# 2. å¦‚æœè¿˜å¡ï¼Œåˆ†æ­¥æ„å»º
vite build --config vite.config.fast.ts

# 3. å¦‚æœè¿˜å¡ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯ä¾èµ–
npx madge --circular src/index.ts
```

## é¢„é˜²æªæ–½

### 1. å®šæœŸæ¸…ç†

```bash
# æ¯å¤©å¼€å§‹å·¥ä½œå‰
cd packages/ui
bun run clean
```

### 2. ä½¿ç”¨ watch æ¨¡å¼è€Œä¸æ˜¯é‡å¤æ„å»º

```bash
# å¼€å‘æ—¶ä½¿ç”¨ watch
bun run dev

# è€Œä¸æ˜¯åå¤è¿è¡Œ build
```

### 3. é™åˆ¶å¹¶å‘æ„å»º

ä¸è¦åŒæ—¶æ„å»ºå¤šä¸ªåŒ…ï¼š

```bash
# âŒ ä¸è¦è¿™æ ·
bun run build  # ä¼šåŒæ—¶æ„å»ºæ‰€æœ‰åŒ…

# âœ… åº”è¯¥è¿™æ ·
turbo build --filter='@juanie/ui'  # åªæ„å»º UI åŒ…
```

### 4. ç›‘æ§æ„å»ºæ—¶é—´

åœ¨ `package.json` ä¸­æ·»åŠ ï¼š

```json
{
  "scripts": {
    "build:timed": "time bun run build"
  }
}
```

å¦‚æœæ„å»ºæ—¶é—´è¶…è¿‡ 2 åˆ†é’Ÿï¼Œè¯´æ˜æœ‰é—®é¢˜ã€‚

## ç»ˆæè§£å†³æ–¹æ¡ˆï¼šæ”¹å˜æ„å»ºç­–ç•¥

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè€ƒè™‘æ”¹å˜ UI åº“çš„æ„å»ºæ–¹å¼ï¼š

### æ–¹æ¡ˆ Aï¼šä¸ä½¿ç”¨ preserveModules

**ä¼˜ç‚¹ï¼š**
- æ„å»ºå¿«
- ä¸å®¹æ˜“å¡æ­»
- å•æ–‡ä»¶è¾“å‡ºï¼Œéƒ¨ç½²ç®€å•

**ç¼ºç‚¹ï¼š**
- Tree-shaking æ•ˆæœç¨å·®
- æ–‡ä»¶è¾ƒå¤§

**å®æ–½ï¼š**
```bash
# å·²ç»åˆ›å»ºäº† vite.config.fast.ts
bun run build:ultra-fast
```

### æ–¹æ¡ˆ Bï¼šé¢„æ„å»ºå‘å¸ƒ

**ç­–ç•¥ï¼š**
1. æœ¬åœ°å¼€å‘æ—¶ä¸æ„å»º UI åŒ…ï¼Œç›´æ¥ä½¿ç”¨æºç 
2. åªåœ¨å‘å¸ƒå‰æ„å»ºä¸€æ¬¡
3. æäº¤æ„å»ºäº§ç‰©åˆ° git

**å®æ–½ï¼š**
```json
// apps/web/vite.config.ts
{
  optimizeDeps: {
    exclude: [], // ä¸æ’é™¤ UI åŒ…ï¼Œè®© Vite é¢„æ„å»º
  }
}
```

### æ–¹æ¡ˆ Cï¼šä½¿ç”¨ unbuild

**æ›¿ä»£ Vite æ„å»ºï¼š**

```bash
# å®‰è£… unbuild
bun add -D unbuild

# åˆ›å»º build.config.ts
```

unbuild ä¸“é—¨ä¸ºåº“æ„å»ºä¼˜åŒ–ï¼Œæ¯” Vite æ›´ç¨³å®šã€‚

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# ğŸš¨ æ„å»ºå¡ä½æ—¶
pkill -9 -f "vite|esbuild|vue-tsc"
cd packages/ui && bun run clean
bun run build:ultra-fast

# ğŸ“Š è¯Šæ–­é—®é¢˜
./scripts/build-with-timeout.sh build:fast
ps aux | grep -E "(vite|esbuild)"
du -sh node_modules/.vite

# ğŸ”§ æ—¥å¸¸ä½¿ç”¨
bun run build:fast          # å¿«é€Ÿæ„å»º
bun run build:ultra-fast    # è¶…å¿«æ„å»º
bun run clean:fast          # æ¸…ç†å¹¶å¿«é€Ÿæ„å»º
./scripts/build-with-timeout.sh  # å¸¦è¶…æ—¶çš„æ„å»º

# ğŸ¥ ç´§æ€¥ä¿®å¤
bun run fix:vite            # å…¨å±€ä¿®å¤è„šæœ¬
bun run ui:clean            # UI åŒ…æ¸…ç†è„šæœ¬
```

## æ€»ç»“

UI åº“æ„å»ºå¡æ­»çš„æ ¸å¿ƒåŸå› æ˜¯ï¼š
1. **æ–‡ä»¶å¤ªå¤š**ï¼ˆ397 ä¸ªï¼‰
2. **ç±»å‹æ£€æŸ¥æ…¢**ï¼ˆvue-tscï¼‰
3. **ç±»å‹ç”Ÿæˆæ…¢**ï¼ˆvite-plugin-dtsï¼‰
4. **I/O æ“ä½œå¤š**ï¼ˆpreserveModulesï¼‰

è§£å†³æ–¹æ¡ˆä¼˜å…ˆçº§ï¼š
1. ğŸ¥‡ ä½¿ç”¨ `build:ultra-fast`ï¼ˆæœ€å¿«ï¼Œæ— ç±»å‹ï¼‰
2. ğŸ¥ˆ ä½¿ç”¨ `build:fast`ï¼ˆå¿«ï¼Œæœ‰ç±»å‹ï¼‰
3. ğŸ¥‰ ä½¿ç”¨å¸¦è¶…æ—¶çš„æ„å»ºè„šæœ¬
4. ğŸ”§ æ”¹å˜æ„å»ºç­–ç•¥ï¼ˆä¸ç”¨ preserveModulesï¼‰

**è®°ä½ï¼šå¼€å‘æ—¶ç”¨ `build:ultra-fast`ï¼Œå‘å¸ƒæ—¶ç”¨ `build`ï¼**
