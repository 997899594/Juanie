# Juanie DevOps 平台流程图

## 🎯 完整 DevOps 流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     1. 项目创建阶段 ✅                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户操作                    系统自动                            │
│  ┌──────────┐              ┌──────────┐                        │
│  │ 创建项目  │─────────────>│ 初始化DB  │                        │
│  └──────────┘              └──────────┘                        │
│       │                          │                              │
│       │                          ▼                              │
│       │                    ┌──────────┐                        │
│       │                    │ 创建仓库  │ (可选)                 │
│       │                    └──────────┘                        │
│       │                          │                              │
│       │                          ▼                              │
│       │                    ┌──────────┐                        │
│       └───────────────────>│ 应用模板  │ (可选)                 │
│                            └──────────┘                        │
│                                  │                              │
│                                  ▼                              │
│                            ┌──────────┐                        │
│                            │ 完成初始化 │                        │
│                            └──────────┘                        │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     2. 代码仓库管理 ⬜                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  选项 A: 连接现有仓库        选项 B: 创建新仓库                  │
│  ┌──────────┐              ┌──────────┐                        │
│  │ GitHub   │              │ 输入名称  │                        │
│  │ GitLab   │              │ 选择可见性 │                        │
│  │ 其他     │              │ 自动初始化 │                        │
│  └──────────┘              └──────────┘                        │
│       │                          │                              │
│       └──────────┬───────────────┘                              │
│                  ▼                                              │
│            ┌──────────┐                                         │
│            │ 仓库已连接 │                                         │
│            └──────────┘                                         │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     3. 环境配置 ⬜                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │ Development │    │  Staging    │    │ Production  │        │
│  ├─────────────┤    ├─────────────┤    ├─────────────┤        │
│  │ 命名空间: dev│    │命名空间:stag│    │命名空间:prod│        │
│  │ 副本数: 1   │    │ 副本数: 2   │    │ 副本数: 3   │        │
│  │ 自动部署    │    │ 可选审批    │    │ 必需审批    │        │
│  │ 资源: 小    │    │ 资源: 中    │    │ 资源: 大    │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     4. GitOps 配置 ⬜                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  4.1 创建 GitOps 仓库                                            │
│  ┌─────────────────────────────────────────────────────┐       │
│  │ project-name-gitops/                                 │       │
│  │ ├── base/                                            │       │
│  │ │   ├── deployment.yaml                             │       │
│  │ │   ├── service.yaml                                │       │
│  │ │   └── kustomization.yaml                          │       │
│  │ └── overlays/                                        │       │
│  │     ├── dev/                                         │       │
│  │     ├── staging/                                     │       │
│  │     └── prod/                                        │       │
│  └─────────────────────────────────────────────────────┘       │
│                          │                                       │
│                          ▼                                       │
│  4.2 配置 Flux 资源                                              │
│  ┌──────────────┐      ┌──────────────┐                        │
│  │GitRepository │─────>│Kustomization │                        │
│  │              │      │              │                        │
│  │ URL: gitops  │      │ Path: dev    │                        │
│  │ Branch: main │      │ Interval: 1m │                        │
│  └──────────────┘      └──────────────┘                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     5. CI/CD 流水线 ⬜                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  开发者推送代码                                                   │
│       │                                                          │
│       ▼                                                          │
│  ┌──────────┐                                                   │
│  │ Git Push │                                                   │
│  └──────────┘                                                   │
│       │                                                          │
│       ▼                                                          │
│  ┌──────────────────────────────────────┐                      │
│  │     CI Pipeline (GitHub Actions)     │                      │
│  ├──────────────────────────────────────┤                      │
│  │ 1. Checkout code                     │                      │
│  │ 2. Run tests                         │                      │
│  │ 3. Build Docker image                │                      │
│  │ 4. Push to registry                  │                      │
│  │ 5. Update GitOps repo                │                      │
│  └──────────────────────────────────────┘                      │
│       │                                                          │
│       ▼                                                          │
│  ┌──────────┐                                                   │
│  │ 镜像已推送 │                                                   │
│  └──────────┘                                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     6. 自动部署 (Flux CD) ⬜                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────┐          │
│  │            Flux CD 工作流程                       │          │
│  └──────────────────────────────────────────────────┘          │
│                          │                                       │
│                          ▼                                       │
│  ┌──────────────┐                                               │
│  │ 1. 检测变更   │ (每 1 分钟)                                   │
│  └──────────────┘                                               │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐                                               │
│  │ 2. 拉取配置   │                                               │
│  └──────────────┘                                               │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐                                               │
│  │ 3. 应用到K8s  │                                               │
│  └──────────────┘                                               │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐      ┌──────────────┐                        │
│  │ 4. 健康检查   │─────>│ 5. 部署完成   │                        │
│  └──────────────┘  ✓   └──────────────┘                        │
│         │                                                        │
│         │ ✗                                                      │
│         ▼                                                        │
│  ┌──────────────┐                                               │
│  │ 6. 自动回滚   │                                               │
│  └──────────────┘                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     7. 监控和告警 ⬜                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │  Prometheus  │───>│   Grafana    │───>│   告警通知    │     │
│  │  (指标收集)   │    │  (可视化)     │    │ (邮件/钉钉)   │     │
│  └──────────────┘    └──────────────┘    └──────────────┘     │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────┐                       │
│  │ 监控指标:                            │                       │
│  │ • CPU 使用率                         │                       │
│  │ • 内存使用率                         │                       │
│  │ • Pod 状态                           │                       │
│  │ • 请求延迟                           │                       │
│  │ • 错误率                             │                       │
│  └─────────────────────────────────────┘                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 日常开发循环

```
┌─────────────────────────────────────────────────────────────┐
│                    开发者日常工作流                          │
└─────────────────────────────────────────────────────────────┘

  开发者本地开发
       │
       ▼
  ┌─────────┐
  │ 编写代码 │
  └─────────┘
       │
       ▼
  ┌─────────┐
  │ 本地测试 │
  └─────────┘
       │
       ▼
  ┌─────────┐
  │ Git Push│
  └─────────┘
       │
       ▼
  ┌──────────────────┐
  │ CI 自动构建镜像   │ (3-5 分钟)
  └──────────────────┘
       │
       ▼
  ┌──────────────────┐
  │ 更新 GitOps 配置 │
  └──────────────────┘
       │
       ▼
  ┌──────────────────┐
  │ Flux 自动部署    │ (1-2 分钟)
  └──────────────────┘
       │
       ▼
  ┌──────────────────┐
  │ 验证部署结果     │
  └──────────────────┘
       │
       ├─ 成功 ──> 继续开发
       │
       └─ 失败 ──> 查看日志 ──> 修复 ──> 重新部署
```

---

## 🎯 关键路径

### 最小可行部署路径 (MVP)

```
1. 创建项目 ✅
   ↓
2. 创建环境 (dev)
   ↓
3. 创建 GitOps 仓库
   ↓
4. 配置 Flux
   ↓
5. 部署应用
   ↓
6. 验证成功 ✓
```

**预计时间**: 30 分钟

### 完整生产部署路径

```
1. 创建项目 ✅
   ↓
2. 连接代码仓库
   ↓
3. 创建多环境 (dev/staging/prod)
   ↓
4. 创建 GitOps 仓库
   ↓
5. 配置 Flux
   ↓
6. 配置 CI/CD
   ↓
7. 配置监控告警
   ↓
8. 配置审批流程
   ↓
9. 部署到 dev
   ↓
10. 测试验证
   ↓
11. 部署到 staging
   ↓
12. 审批
   ↓
13. 部署到 prod
   ↓
14. 监控运行 ✓
```

**预计时间**: 2-3 小时

---

## 🔀 分支策略

```
┌─────────────────────────────────────────────────────────────┐
│                    Git 分支策略                              │
└─────────────────────────────────────────────────────────────┘

  main (生产)
    │
    ├─── release/v1.0 (预发布)
    │      │
    │      └─── feature/new-feature (功能开发)
    │
    └─── develop (开发)
           │
           ├─── feature/feature-a
           │
           └─── feature/feature-b


部署映射:
• feature/* → dev 环境 (自动部署)
• develop → dev 环境 (自动部署)
• release/* → staging 环境 (自动部署 + 可选审批)
• main → prod 环境 (手动触发 + 必需审批)
```

---

## 📊 数据流向

```
┌─────────────────────────────────────────────────────────────┐
│                    数据流向图                                │
└─────────────────────────────────────────────────────────────┘

  源代码仓库 (GitHub/GitLab)
       │
       ▼
  CI/CD Pipeline
       │
       ├─── 构建 ───> Docker 镜像 ───> 镜像仓库
       │
       └─── 更新 ───> GitOps 仓库
                           │
                           ▼
                      Flux CD
                           │
                           ▼
                      K3s 集群
                           │
                           ├─── Pod (应用容器)
                           │
                           ├─── Service (服务发现)
                           │
                           ├─── Ingress (外部访问)
                           │
                           └─── PV/PVC (持久化存储)
                                    │
                                    ▼
                               用户访问
```

---

## 🎨 架构层次

```
┌─────────────────────────────────────────────────────────────┐
│                    架构分层图                                │
└─────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────┐
  │              用户界面层 (Juanie Web UI)                  │
  │  • 项目管理  • 部署管理  • 监控面板  • 配置管理          │
  └─────────────────────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────┐
  │              API 层 (Juanie API Gateway)                │
  │  • tRPC API  • 认证授权  • 业务逻辑  • 事件总线         │
  └─────────────────────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────┐
  │              GitOps 层 (Flux CD)                        │
  │  • Git 同步  • 资源协调  • 健康检查  • 自动回滚         │
  └─────────────────────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────┐
  │              容器编排层 (K3s/Kubernetes)                 │
  │  • Pod 调度  • 服务发现  • 负载均衡  • 存储管理         │
  └─────────────────────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────┐
  │              基础设施层 (服务器/云平台)                   │
  │  • 计算资源  • 网络  • 存储  • 监控                      │
  └─────────────────────────────────────────────────────────┘
```

---

## 🚦 状态转换

```
项目状态转换:

  initializing ──> active ──> archived
       │              │
       └──> failed    └──> suspended


部署状态转换:

  pending ──> running ──> success
       │         │
       │         └──> failed ──> rollback
       │
       └──> cancelled


环境状态转换:

  creating ──> active ──> updating ──> active
       │         │
       │         └──> deleting ──> deleted
       │
       └──> failed
```

---

**提示**: 这些流程图帮助你理解整个 DevOps 平台的工作原理。建议配合 [完整指南](./DEVOPS_WORKFLOW_GUIDE.md) 和 [快速开始清单](./QUICK_START_CHECKLIST.md) 一起使用。
