# é¡¹ç›®åˆå§‹åŒ–æµç¨‹ - çŠ¶æ€æœºæµç¨‹å›¾

## ğŸ”„ å®Œæ•´çŠ¶æ€è½¬æ¢å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      IDLE       â”‚
                    â”‚   (åˆå§‹çŠ¶æ€)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ START
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CREATING_PROJECTâ”‚
                    â”‚  (åˆ›å»ºé¡¹ç›®è®°å½•)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ PROJECT_CREATED
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ LOADING_TEMPLATEâ”‚â—„â”€â”€â”€ å¯é€‰
                    â”‚  (åŠ è½½æ¨¡æ¿é…ç½®)  â”‚     (æœ‰ templateId æ—¶)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ TEMPLATE_LOADED
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚RENDERING_TEMPLATEâ”‚â—„â”€â”€â”€ å¯é€‰
                    â”‚  (æ¸²æŸ“æ¨¡æ¿æ–‡ä»¶)  â”‚     (æœ‰æ¨¡æ¿ä¸”æœ‰ä»“åº“æ—¶)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ TEMPLATE_RENDERED
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚CREATING_ENVS    â”‚
                    â”‚ (åˆ›å»º 3 ä¸ªç¯å¢ƒ)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ENVIRONMENTS_CREATED
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚SETTING_UP_REPO  â”‚â—„â”€â”€â”€ å¯é€‰
                    â”‚ (è®¾ç½® Git ä»“åº“)  â”‚     (æœ‰ repository æ—¶)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ REPOSITORY_READY
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CREATING_GITOPS â”‚â—„â”€â”€â”€ å¯é€‰
                    â”‚(åˆ›å»º GitOps èµ„æº)â”‚     (æœ‰ä»“åº“ä¸” Flux å·²å®‰è£…)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ GITOPS_CREATED
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   FINALIZING    â”‚
                    â”‚ (æ›´æ–°çŠ¶æ€/é€šçŸ¥)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ FINALIZED
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   COMPLETED     â”‚
                    â”‚   (å®Œæˆ)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    ä»»ä½•çŠ¶æ€å‘ç”Ÿé”™è¯¯
                             â”‚ ERROR
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     FAILED      â”‚
                    â”‚   (å¤±è´¥)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š çŠ¶æ€è¯¦æƒ…

### 1. CREATING_PROJECT (10%)

**èŒè´£**: åˆ›å»ºé¡¹ç›®æ•°æ®åº“è®°å½•

**è¾“å…¥**:
- userId
- organizationId
- projectData (name, slug, description, etc.)

**è¾“å‡º**:
- projectId

**å¤„ç†å™¨**: `CreateProjectHandler`

**å¯èƒ½çš„é”™è¯¯**:
- é¡¹ç›® slug å·²å­˜åœ¨
- æ•°æ®åº“è¿æ¥å¤±è´¥
- æƒé™ä¸è¶³

---

### 2. LOADING_TEMPLATE (20%)

**èŒè´£**: åŠ è½½æ¨¡æ¿é…ç½®

**æ¡ä»¶**: `canHandle = !!context.templateId`

**è¾“å…¥**:
- templateId

**è¾“å‡º**:
- templatePath

**å¤„ç†å™¨**: `LoadTemplateHandler`

**å¯èƒ½çš„é”™è¯¯**:
- æ¨¡æ¿ä¸å­˜åœ¨
- æ¨¡æ¿é…ç½®æ— æ•ˆ

---

### 3. RENDERING_TEMPLATE (30%)

**èŒè´£**: æ¸²æŸ“æ¨¡æ¿æ–‡ä»¶

**æ¡ä»¶**: `canHandle = !!context.templatePath && !!context.repository`

**è¾“å…¥**:
- templatePath
- projectData
- templateConfig

**è¾“å‡º**:
- renderedTemplatePath

**å¤„ç†å™¨**: `RenderTemplateHandler`

**å¯èƒ½çš„é”™è¯¯**:
- æ¨¡æ¿æ¸²æŸ“å¤±è´¥
- æ–‡ä»¶ç³»ç»Ÿé”™è¯¯

---

### 4. CREATING_ENVIRONMENTS (50%)

**èŒè´£**: åˆ›å»º 3 ä¸ªé»˜è®¤ç¯å¢ƒ

**æ¡ä»¶**: `canHandle = true` (æ€»æ˜¯æ‰§è¡Œ)

**è¾“å…¥**:
- projectId
- userId

**è¾“å‡º**:
- environmentIds (3 ä¸ª)

**å¤„ç†å™¨**: `CreateEnvironmentsHandler`

**ç¯å¢ƒåˆ—è¡¨**:
1. Development (å¼€å‘ç¯å¢ƒ)
   - approvalRequired: false
   - minApprovals: 0

2. Staging (é¢„å‘å¸ƒç¯å¢ƒ)
   - approvalRequired: true
   - minApprovals: 1

3. Production (ç”Ÿäº§ç¯å¢ƒ)
   - approvalRequired: true
   - minApprovals: 2

**å¯èƒ½çš„é”™è¯¯**:
- ç¯å¢ƒåˆ›å»ºå¤±è´¥
- éƒ¨åˆ†ç¯å¢ƒåˆ›å»ºå¤±è´¥ï¼ˆä¼šç»§ç»­ï¼‰

---

### 5. SETTING_UP_REPOSITORY (70%)

**èŒè´£**: è®¾ç½® Git ä»“åº“

**æ¡ä»¶**: `canHandle = !!context.repository`

**è¾“å…¥**:
- repository (mode, provider, url/name, accessToken)

**è¾“å‡º**:
- repositoryId (å¿«é€Ÿè·¯å¾„)
- jobIds (æ…¢é€Ÿè·¯å¾„)

**å¤„ç†å™¨**: `SetupRepositoryHandler`

**ä¸¤ç§æ¨¡å¼**:

#### å¿«é€Ÿè·¯å¾„ (existing)
```
å…³è”ç°æœ‰ä»“åº“ (åŒæ­¥)
  â†“
éªŒè¯ä»“åº“å­˜åœ¨
  â†“
åˆ›å»ºæ•°æ®åº“è®°å½•
  â†“
è¿”å› repositoryId
```

#### æ…¢é€Ÿè·¯å¾„ (create)
```
åˆ›å»ºæ–°ä»“åº“ (å¼‚æ­¥)
  â†“
æ·»åŠ åˆ°é˜Ÿåˆ—
  â†“
è¿”å› jobId
  â†“
Worker å¤„ç†
  â†“
é€šè¿‡ SSE é€šçŸ¥å‰ç«¯
```

**å¯èƒ½çš„é”™è¯¯**:
- OAuth ä»¤ç‰Œæ— æ•ˆ
- ä»“åº“ä¸å­˜åœ¨
- ä»“åº“åˆ›å»ºå¤±è´¥
- æƒé™ä¸è¶³

---

### 6. CREATING_GITOPS (85%)

**èŒè´£**: åˆ›å»º GitOps èµ„æº

**æ¡ä»¶**: `canHandle = !!context.repositoryId && flux.isInstalled()`

**è¾“å…¥**:
- projectId
- repositoryId
- environmentIds

**è¾“å‡º**:
- gitopsResourceIds

**å¤„ç†å™¨**: `CreateGitOpsHandler`

**ä¸ºæ¯ä¸ªç¯å¢ƒåˆ›å»º**:
- GitRepository èµ„æº
- Kustomization èµ„æº

**å¯èƒ½çš„é”™è¯¯**:
- Flux æœªå®‰è£…
- K8s è¿æ¥å¤±è´¥
- èµ„æºåˆ›å»ºå¤±è´¥ï¼ˆéè‡´å‘½ï¼‰

---

### 7. FINALIZING (100%)

**èŒè´£**: å®Œæˆåˆå§‹åŒ–

**æ¡ä»¶**: `canHandle = true` (æ€»æ˜¯æ‰§è¡Œ)

**è¾“å…¥**:
- projectId
- æ‰€æœ‰å·²åˆ›å»ºçš„èµ„æº ID

**è¾“å‡º**:
- æ— 

**å¤„ç†å™¨**: `FinalizeHandler`

**æ“ä½œ**:
1. æ›´æ–°é¡¹ç›®çŠ¶æ€ä¸º 'active'
2. è®°å½•å®¡è®¡æ—¥å¿—
3. å‘é€é€šçŸ¥

**å¯èƒ½çš„é”™è¯¯**:
- æ•°æ®åº“æ›´æ–°å¤±è´¥
- é€šçŸ¥å‘é€å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰

---

## ğŸ¯ æ‰§è¡Œè·¯å¾„ç¤ºä¾‹

### åœºæ™¯ 1: ç©ºé¡¹ç›®ï¼ˆæœ€ç®€å•ï¼‰

```
IDLE
  â†’ CREATING_PROJECT (10%)
  â†’ LOADING_TEMPLATE (è·³è¿‡)
  â†’ RENDERING_TEMPLATE (è·³è¿‡)
  â†’ CREATING_ENVIRONMENTS (50%)
  â†’ SETTING_UP_REPOSITORY (è·³è¿‡)
  â†’ CREATING_GITOPS (è·³è¿‡)
  â†’ FINALIZING (100%)
  â†’ COMPLETED
```

**æ—¶é—´**: ~2 ç§’

---

### åœºæ™¯ 2: ä½¿ç”¨æ¨¡æ¿ + å…³è”ç°æœ‰ä»“åº“ï¼ˆå¿«é€Ÿï¼‰

```
IDLE
  â†’ CREATING_PROJECT (10%)
  â†’ LOADING_TEMPLATE (20%)
  â†’ RENDERING_TEMPLATE (30%)
  â†’ CREATING_ENVIRONMENTS (50%)
  â†’ SETTING_UP_REPOSITORY (70%) [å¿«é€Ÿè·¯å¾„]
  â†’ CREATING_GITOPS (85%)
  â†’ FINALIZING (100%)
  â†’ COMPLETED
```

**æ—¶é—´**: ~5 ç§’

---

### åœºæ™¯ 3: ä½¿ç”¨æ¨¡æ¿ + åˆ›å»ºæ–°ä»“åº“ï¼ˆæ…¢é€Ÿï¼‰

```
IDLE
  â†’ CREATING_PROJECT (10%)
  â†’ LOADING_TEMPLATE (20%)
  â†’ RENDERING_TEMPLATE (30%)
  â†’ CREATING_ENVIRONMENTS (50%)
  â†’ SETTING_UP_REPOSITORY (70%) [æ…¢é€Ÿè·¯å¾„ï¼Œè¿”å› jobId]
  â†’ CREATING_GITOPS (è·³è¿‡ï¼Œç­‰å¾…ä»“åº“åˆ›å»º)
  â†’ FINALIZING (100%)
  â†’ COMPLETED

åå° Worker:
  â†’ åˆ›å»º Git ä»“åº“
  â†’ æ¨é€åˆå§‹ä»£ç 
  â†’ åˆ›å»º GitOps èµ„æº
  â†’ é€šè¿‡ SSE é€šçŸ¥å‰ç«¯
```

**æ—¶é—´**: 
- ä¸»æµç¨‹: ~3 ç§’
- åå°ä»»åŠ¡: ~30 ç§’

---

## ğŸ” çŠ¶æ€æœºå†…éƒ¨æµç¨‹

### æ‰§è¡Œå¾ªç¯

```typescript
while (currentState !== 'COMPLETED' && currentState !== 'FAILED') {
  // 1. è·å–å½“å‰çŠ¶æ€çš„å¤„ç†å™¨
  handler = handlers.get(currentState)
  
  // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œ
  if (!handler.canHandle(context)) {
    // è·³è¿‡æ­¤çŠ¶æ€
    transition(context, getNextEvent(currentState))
    continue
  }
  
  // 3. æ›´æ–°è¿›åº¦
  context.progress = handler.getProgress()
  
  // 4. æ‰§è¡Œå¤„ç†å™¨
  try {
    await handler.execute(context)
    
    // 5. è½¬æ¢åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€
    transition(context, getNextEvent(currentState))
  } catch (error) {
    // 6. é”™è¯¯å¤„ç†
    context.error = error
    transition(context, 'ERROR')
  }
}
```

---

## ğŸ“ˆ è¿›åº¦è¿½è¸ª

```
0%   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IDLE
10%  â–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CREATING_PROJECT
20%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOADING_TEMPLATE
30%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RENDERING_TEMPLATE
50%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CREATING_ENVIRONMENTS
70%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SETTING_UP_REPOSITORY
85%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€ CREATING_GITOPS
100% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ COMPLETED
```

---

## ğŸ¨ å‰ç«¯é›†æˆ

### ç›‘å¬è¿›åº¦

```typescript
// å‰ç«¯ä»£ç 
const { project, jobIds } = await createProject(data)

if (jobIds && jobIds.length > 0) {
  // æœ‰å¼‚æ­¥ä»»åŠ¡ï¼Œç›‘å¬è¿›åº¦
  const eventSource = new EventSource(`/api/jobs/${jobIds[0]}/progress`)
  
  eventSource.onmessage = (event) => {
    const { state, progress } = JSON.parse(event.data)
    
    // æ›´æ–° UI
    updateProgress(progress)
    updateStatus(state)
  }
  
  eventSource.addEventListener('completed', () => {
    eventSource.close()
    showSuccess('é¡¹ç›®åˆå§‹åŒ–å®Œæˆ')
  })
  
  eventSource.addEventListener('failed', (event) => {
    eventSource.close()
    showError(event.data)
  })
}
```

---

## ğŸ”§ æ‰©å±•ç¤ºä¾‹

### æ·»åŠ æ–°çŠ¶æ€: CREATING_DATABASE

```typescript
// 1. æ›´æ–°çŠ¶æ€è½¬æ¢è¡¨
CREATING_ENVIRONMENTS: {
  ENVIRONMENTS_CREATED: 'CREATING_DATABASE',  // æ–°å¢
},
CREATING_DATABASE: {
  DATABASE_CREATED: 'SETTING_UP_REPOSITORY',  // æ–°å¢
},

// 2. åˆ›å»ºå¤„ç†å™¨
@Injectable()
export class CreateDatabaseHandler implements StateHandler {
  readonly name = 'CREATING_DATABASE'
  
  canHandle(context: InitializationContext): boolean {
    return !!context.databaseConfig
  }
  
  getProgress(): number {
    return 60  // åœ¨ç¯å¢ƒ(50%)å’Œä»“åº“(70%)ä¹‹é—´
  }
  
  async execute(context: InitializationContext): Promise<void> {
    const database = await this.databaseService.create(...)
    context.databaseId = database.id
  }
}

// 3. æ³¨å†Œå¤„ç†å™¨
this.stateMachine.registerHandler(this.createDatabaseHandler)
```

**æ–°çš„æµç¨‹å›¾**:
```
CREATING_ENVIRONMENTS (50%)
  â†“
CREATING_DATABASE (60%)  â† æ–°å¢
  â†“
SETTING_UP_REPOSITORY (70%)
```

---

## ğŸ“ æ€»ç»“

çŠ¶æ€æœºæ¨¡å¼çš„ä¼˜åŠ¿ï¼š

1. **æ¸…æ™°çš„æµç¨‹** - ä¸€ç›®äº†ç„¶çš„çŠ¶æ€è½¬æ¢
2. **çµæ´»çš„æ‰§è¡Œ** - é€šè¿‡ `canHandle` æ§åˆ¶æ˜¯å¦æ‰§è¡Œ
3. **æ˜“äºæ‰©å±•** - æ·»åŠ æ–°çŠ¶æ€ä¸å½±å“ç°æœ‰ä»£ç 
4. **æ˜“äºæµ‹è¯•** - æ¯ä¸ªçŠ¶æ€ç‹¬ç«‹æµ‹è¯•
5. **æ˜“äºè°ƒè¯•** - æ¸…æ™°çš„æ‰§è¡Œè·¯å¾„
6. **è¿›åº¦è¿½è¸ª** - ç²¾ç¡®çš„è¿›åº¦ç™¾åˆ†æ¯”
7. **é”™è¯¯å¤„ç†** - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

è¿™æ˜¯ä¸€ä¸ª**æ•™ç§‘ä¹¦çº§åˆ«çš„çŠ¶æ€æœºå®ç°**ï¼
