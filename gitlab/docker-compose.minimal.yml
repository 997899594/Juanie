services:
  gitlab:
    # 使用较老但更小的GitLab版本 (约1.5GB vs 新版本2.5GB+)
    image: gitlab/gitlab-ce:13.12.15-ce.0
    container_name: gitlab-minimal
    restart: unless-stopped
    hostname: localhost
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://localhost:8080'
        gitlab_rails['initial_root_password'] = 'admin123456'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        
        # 极简配置 - 禁用所有非核心功能
        prometheus_monitoring['enable'] = false
        alertmanager['enable'] = false
        node_exporter['enable'] = false
        redis_exporter['enable'] = false
        postgres_exporter['enable'] = false
        gitlab_exporter['enable'] = false
        grafana['enable'] = false
        
        # 禁用额外服务
        gitlab_pages['enable'] = false
        gitlab_rails['registry_enabled'] = false
        mattermost['enable'] = false
        
        # 最小化数据库
        postgresql['shared_buffers'] = "32MB"
        postgresql['max_connections'] = 20
        
        # 最小化Redis
        redis['maxmemory'] = "32mb"
        
        # 禁用不必要功能
        gitlab_rails['usage_ping_enabled'] = false
        gitlab_rails['sentry_enabled'] = false
        gitlab_rails['gitlab_email_enabled'] = false
        gitlab_rails['artifacts_enabled'] = false
        gitlab_rails['lfs_enabled'] = false
        
        # 最小化Web服务器
        unicorn['worker_processes'] = 1
        sidekiq['concurrency'] = 3
        
    ports:
      - "8080:80"
      - "2222:22"
    volumes:
      - gitlab_data:/var/opt/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_config:/etc/gitlab
    shm_size: '64m'
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

volumes:
  gitlab_data:
  gitlab_logs:
  gitlab_config: