import { Injectable } from '@nestjs/common';
import { TrpcService } from '../../trpc/trpc.service';
import { VulnerabilityScansService } from './vulnerability-scans.service';
import { z } from 'zod';
import {
  insertVulnerabilityScanSchema,
  updateVulnerabilityScanSchema,
  selectVulnerabilityScanSchema,
  ScanTypeEnum,
  TargetTypeEnum,
  RiskLevelEnum,
  RemediationStatusEnum
} from '../../database/schemas/vulnerability-scans.schema';

@Injectable()
export class VulnerabilityScansRouter {
  constructor(
    private readonly vulnerabilityScansService: VulnerabilityScansService,
    private readonly trpc: TrpcService
  ) {}

  public get vulnerabilityScansRouter() {
    return this.trpc.router({
      // Hello endpoint for testing
      hello: this.trpc.publicProcedure
        .input(z.object({ name: z.string().optional() }))
        .query(({ input }) => {
          return {
            greeting: `Hello ${input.name ?? 'Vulnerability Scans'}!`,
          };
        }),

      // 创建漏洞扫描
      create: this.trpc.protectedProcedure
        .input(insertVulnerabilityScanSchema)
        .output(selectVulnerabilityScanSchema)
        .mutation(async ({ input }) => {
          return await this.vulnerabilityScansService.createVulnerabilityScan(input);
        }),

      // 根据ID获取漏洞扫描
      getById: this.trpc.protectedProcedure
        .input(z.object({ id: z.string().uuid() }))
        .output(selectVulnerabilityScanSchema.nullable())
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getVulnerabilityScanById(input.id);
        }),

      // 更新漏洞扫描
      update: this.trpc.protectedProcedure
        .input(z.object({
          id: z.string().uuid(),
          data: updateVulnerabilityScanSchema,
        }))
        .output(selectVulnerabilityScanSchema.nullable())
        .mutation(async ({ input }) => {
          return await this.vulnerabilityScansService.updateVulnerabilityScan(input.id, input.data);
        }),

      // 删除漏洞扫描
      delete: this.trpc.protectedProcedure
        .input(z.object({ id: z.string().uuid() }))
        .output(z.boolean())
        .mutation(async ({ input }) => {
          return await this.vulnerabilityScansService.deleteVulnerabilityScan(input.id);
        }),

      // 根据项目获取扫描列表
      getByProject: this.trpc.protectedProcedure
        .input(z.object({
          projectId: z.string().uuid(),
          limit: z.number().min(1).max(100).default(50),
          offset: z.number().min(0).default(0),
        }))
        .output(z.array(selectVulnerabilityScanSchema))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getScansByProject(
            input.projectId,
            input.limit,
            input.offset
          );
        }),

      // 根据仓库获取扫描列表
      getByRepository: this.trpc.protectedProcedure
        .input(z.object({
          repositoryId: z.string().uuid(),
          limit: z.number().min(1).max(100).default(50),
          offset: z.number().min(0).default(0),
        }))
        .output(z.array(selectVulnerabilityScanSchema))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getScansByRepository(
            input.repositoryId,
            input.limit,
            input.offset
          );
        }),

      // 根据扫描类型获取列表
      getByScanType: this.trpc.protectedProcedure
        .input(z.object({
          scanType: ScanTypeEnum,
          limit: z.number().min(1).max(100).default(50),
          offset: z.number().min(0).default(0),
        }))
        .output(z.array(selectVulnerabilityScanSchema))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getScansByScanType(
            input.scanType,
            input.limit,
            input.offset
          );
        }),

      // 根据风险级别获取列表
      getByRiskLevel: this.trpc.protectedProcedure
        .input(z.object({
          riskLevel: RiskLevelEnum,
          limit: z.number().min(1).max(100).default(50),
          offset: z.number().min(0).default(0),
        }))
        .output(z.array(selectVulnerabilityScanSchema))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getScansByRiskLevel(
            input.riskLevel,
            input.limit,
            input.offset
          );
        }),

      // 获取高风险扫描
      getHighRisk: this.trpc.protectedProcedure
        .input(z.object({
          projectId: z.string().uuid().optional(),
          repositoryId: z.string().uuid().optional(),
          limit: z.number().min(1).max(100).default(50),
          offset: z.number().min(0).default(0),
        }))
        .output(z.array(selectVulnerabilityScanSchema))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getHighRiskScans(
            input.projectId,
            input.repositoryId,
            input.limit,
            input.offset
          );
        }),

      // 获取待修复扫描
      getPendingRemediation: this.trpc.protectedProcedure
        .input(z.object({
          projectId: z.string().uuid().optional(),
          repositoryId: z.string().uuid().optional(),
          limit: z.number().min(1).max(100).default(50),
          offset: z.number().min(0).default(0),
        }))
        .output(z.array(selectVulnerabilityScanSchema))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getPendingRemediationScans(
            input.projectId,
            input.repositoryId,
            input.limit,
            input.offset
          );
        }),

      // 搜索扫描
      search: this.trpc.protectedProcedure
        .input(z.object({
          query: z.string(),
          filters: z.object({
            projectId: z.string().uuid().optional(),
            repositoryId: z.string().uuid().optional(),
            scanType: ScanTypeEnum.optional(),
            targetType: TargetTypeEnum.optional(),
            overallRiskLevel: RiskLevelEnum.optional(),
            remediationStatus: RemediationStatusEnum.optional(),
            minRiskScore: z.number().optional(),
            maxRiskScore: z.number().optional(),
            scannerName: z.string().optional(),
            dateFrom: z.date().optional(),
            dateTo: z.date().optional(),
          }).optional(),
          limit: z.number().min(1).max(100).default(50),
          offset: z.number().min(0).default(0),
        }))
        .output(z.array(selectVulnerabilityScanSchema))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.searchScans(
            input.query,
            input.filters,
            input.limit,
            input.offset
          );
        }),

      // 更新修复状态
      updateRemediationStatus: this.trpc.protectedProcedure
        .input(z.object({
          id: z.string().uuid(),
          status: RemediationStatusEnum,
          progress: z.number().min(0).max(100).optional(),
        }))
        .output(z.boolean())
        .mutation(async ({ input }) => {
          return await this.vulnerabilityScansService.updateRemediationStatus(
            input.id,
            input.status,
            input.progress
          );
        }),

      // 批量更新修复状态
      batchUpdateRemediationStatus: this.trpc.protectedProcedure
        .input(z.object({
          ids: z.array(z.string().uuid()).min(1).max(50),
          status: RemediationStatusEnum,
        }))
        .output(z.number())
        .mutation(async ({ input }) => {
          return await this.vulnerabilityScansService.batchUpdateRemediationStatus(
            input.ids,
            input.status
          );
        }),

      // 批量删除扫描
      batchDelete: this.trpc.protectedProcedure
        .input(z.object({
          ids: z.array(z.string().uuid()).min(1).max(50),
        }))
        .output(z.number())
        .mutation(async ({ input }) => {
          return await this.vulnerabilityScansService.batchDeleteScans(input.ids);
        }),

      // 获取扫描统计
      getStats: this.trpc.protectedProcedure
        .input(z.object({
          projectId: z.string().uuid().optional(),
          repositoryId: z.string().uuid().optional(),
        }))
        .output(z.object({
          total: z.number(),
          byScanType: z.record(z.string(), z.number()),
          byRiskLevel: z.record(z.string(), z.number()),
          byRemediationStatus: z.record(z.string(), z.number()),
          averageRiskScore: z.number(),
          totalVulnerabilities: z.number(),
          remediationRate: z.number(),
        }))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getScanStats(
            input.projectId,
            input.repositoryId
          );
        }),

      // 获取扫描数量
      getCount: this.trpc.protectedProcedure
        .input(z.object({
          projectId: z.string().uuid().optional(),
          repositoryId: z.string().uuid().optional(),
          scanType: ScanTypeEnum.optional(),
          riskLevel: RiskLevelEnum.optional(),
        }))
        .output(z.number())
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getScanCount(
            input.projectId,
            input.repositoryId,
            input.scanType,
            input.riskLevel
          );
        }),

      // 获取扫描详情（包含关联信息）
      getWithDetails: this.trpc.protectedProcedure
        .input(z.object({ id: z.string().uuid() }))
        .output(z.any()) // 复杂对象，使用any
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getScanWithDetails(input.id);
        }),

      // 获取最新扫描
      getLatest: this.trpc.protectedProcedure
        .input(z.object({
          projectId: z.string().uuid().optional(),
          repositoryId: z.string().uuid().optional(),
          scanType: ScanTypeEnum.optional(),
          limit: z.number().min(1).max(100).default(10),
        }))
        .output(z.array(selectVulnerabilityScanSchema))
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getLatestScans(
            input.projectId,
            input.repositoryId,
            input.scanType,
            input.limit
          );
        }),

      // 获取扫描趋势
      getTrends: this.trpc.protectedProcedure
        .input(z.object({
          projectId: z.string().uuid().optional(),
          repositoryId: z.string().uuid().optional(),
          days: z.number().min(1).max(365).default(30),
        }))
        .output(z.array(z.any())) // 趋势数据结构复杂，使用any
        .query(async ({ input }) => {
          return await this.vulnerabilityScansService.getScanTrends(
            input.projectId,
            input.repositoryId,
            input.days
          );
        }),

      // 验证扫描数据
      validate: this.trpc.protectedProcedure
        .input(selectVulnerabilityScanSchema.partial())
        .output(z.object({
          isValid: z.boolean(),
          errors: z.array(z.string()),
        }))
        .mutation(async ({ input }) => {
          return await this.vulnerabilityScansService.validateScan(input);
        }),
    });
  }
}