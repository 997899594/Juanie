import { pgTable, uuid, integer, text, timestamp, boolean, decimal, index, pgEnum } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
import { z } from 'zod';
import { projects } from './projects.schema';
import { repositories } from './repositories.schema';

// 枚举定义
export const ScanTypeEnum = z.enum(['sast', 'dast', 'dependency', 'container', 'infrastructure']);
export const TargetTypeEnum = z.enum(['code', 'container', 'deployment', 'infrastructure']);
export const RiskLevelEnum = z.enum(['low', 'medium', 'high', 'critical']);
export const RemediationStatusEnum = z.enum(['pending', 'in_progress', 'completed', 'false_positive', 'accepted_risk']);

export const ScanTypePgEnum = pgEnum('scan_type', ['sast', 'dast', 'dependency', 'container', 'infrastructure']);
export const TargetTypePgEnum = pgEnum('target_type', ['code', 'container', 'deployment', 'infrastructure']);
export const RiskLevelPgEnum = pgEnum('risk_level', ['low', 'medium', 'high', 'critical']);
export const RemediationStatusPgEnum = pgEnum('remediation_status', ['pending', 'in_progress', 'completed', 'false_positive', 'accepted_risk']);

export const vulnerabilityScans = pgTable('vulnerability_scans', {
  id: uuid('id').defaultRandom().primaryKey(),
  projectId: uuid('project_id').references(() => projects.id),
  repositoryId: uuid('repository_id').references(() => repositories.id),
  
  // 扫描信息
  scanType: ScanTypePgEnum('scan_type').notNull(),
  scannerName: text('scanner_name').notNull(),
  scannerVersion: text('scanner_version'),
  
  // 扫描目标
  targetType: TargetTypePgEnum('target_type').notNull(),
  targetIdentifier: text('target_identifier').notNull(),
  
  // 扫描结果
  totalVulnerabilities: integer('total_vulnerabilities').default(0),
  criticalCount: integer('critical_count').default(0),
  highCount: integer('high_count').default(0),
  mediumCount: integer('medium_count').default(0),
  lowCount: integer('low_count').default(0),
  
  // 简化 findings - 核心发现统计
  topFindings: text('top_findings'),
  mostSevereFinding: text('most_severe_finding'),
  scanConfidence: decimal('scan_confidence', { precision: 3, scale: 2 }),
  
  // 简化 aiRiskAssessment - 核心风险评估
  overallRiskLevel: RiskLevelPgEnum('overall_risk_level'),
  riskScore: integer('risk_score'),
  aiAnalysisSummary: text('ai_analysis_summary'),
  
  // 简化 aiRemediationSuggestions - 核心修复建议
  topRemediationSuggestion: text('top_remediation_suggestion'),
  estimatedFixTime: integer('estimated_fix_time'),
  
  // 误报预测
  falsePositiveRate: decimal('false_positive_rate', { precision: 3, scale: 2 }),
  highConfidenceFindings: integer('high_confidence_findings').default(0),
  
  // 修复状态统计
  remediatedCount: integer('remediated_count').default(0),
  remediationProgress: decimal('remediation_progress', { precision: 5, scale: 2 }),
  remediationPriority: text('remediation_priority'),
  remediationStatus: RemediationStatusPgEnum('remediation_status'),
  
  scanStartedAt: timestamp('scan_started_at'),
  scanCompletedAt: timestamp('scan_completed_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

// Indexes
export const vulnerabilityScansProjectIdx = index('vulnerability_scans_project_idx').on(vulnerabilityScans.projectId);
export const vulnerabilityScansRepositoryIdx = index('vulnerability_scans_repository_idx').on(vulnerabilityScans.repositoryId);
export const vulnerabilityScansScanTypeIdx = index('vulnerability_scans_scan_type_idx').on(vulnerabilityScans.scanType);
export const vulnerabilityScansTargetTypeIdx = index('vulnerability_scans_target_type_idx').on(vulnerabilityScans.targetType);
export const vulnerabilityScansCreatedAtIdx = index('vulnerability_scans_created_at_idx').on(vulnerabilityScans.createdAt);

// 复合索引（优化查询）
export const vulnerabilityScansRepoSeverityCreatedIdx = index('vuln_scans_repo_severity_created_idx').on(
  vulnerabilityScans.repositoryId,
  vulnerabilityScans.overallRiskLevel,
  vulnerabilityScans.createdAt,
);

// Relations
export const vulnerabilityScansRelations = relations(vulnerabilityScans, ({ one }) => ({
  project: one(projects, {
    fields: [vulnerabilityScans.projectId],
    references: [projects.id],
  }),
  repository: one(repositories, {
    fields: [vulnerabilityScans.repositoryId],
    references: [repositories.id],
  }),
}));

export const insertVulnerabilityScanSchema = z.object({
  id: z.string().uuid().optional(),
  projectId: z.string().uuid().optional(),
  repositoryId: z.string().uuid().optional(),
  scanType: ScanTypeEnum,
  scannerName: z.string(),
  scannerVersion: z.string().optional(),
  targetType: TargetTypeEnum,
  targetIdentifier: z.string(),
  totalVulnerabilities: z.number().int().optional(),
  criticalCount: z.number().int().optional(),
  highCount: z.number().int().optional(),
  mediumCount: z.number().int().optional(),
  lowCount: z.number().int().optional(),
  topFindings: z.string().optional(),
  mostSevereFinding: z.string().optional(),
  scanConfidence: z.string().optional(),
  overallRiskLevel: RiskLevelEnum.optional(),
  riskScore: z.number().int().optional(),
  aiAnalysisSummary: z.string().optional(),
  topRemediationSuggestion: z.string().optional(),
  estimatedFixTime: z.number().int().optional(),
  falsePositiveRate: z.string().optional(),
  highConfidenceFindings: z.number().int().optional(),
  remediatedCount: z.number().int().optional(),
  remediationProgress: z.string().optional(),
  remediationPriority: z.string().optional(),
  remediationStatus: RemediationStatusEnum.optional(),
  scanStartedAt: z.date().optional(),
  scanCompletedAt: z.date().optional(),
  createdAt: z.date().optional(),
});

export const selectVulnerabilityScanSchema = z.object({
  id: z.string().uuid(),
  projectId: z.string().uuid().nullable(),
  repositoryId: z.string().uuid().nullable(),
  scanType: ScanTypeEnum,
  scannerName: z.string(),
  scannerVersion: z.string().nullable(),
  targetType: TargetTypeEnum,
  targetIdentifier: z.string(),
  totalVulnerabilities: z.number().int().nullable(),
  criticalCount: z.number().int().nullable(),
  highCount: z.number().int().nullable(),
  mediumCount: z.number().int().nullable(),
  lowCount: z.number().int().nullable(),
  topFindings: z.string().nullable(),
  mostSevereFinding: z.string().nullable(),
  scanConfidence: z.string().nullable(),
  overallRiskLevel: RiskLevelEnum.nullable(),
  riskScore: z.number().int().nullable(),
  aiAnalysisSummary: z.string().nullable(),
  topRemediationSuggestion: z.string().nullable(),
  estimatedFixTime: z.number().int().nullable(),
  falsePositiveRate: z.string().nullable(),
  highConfidenceFindings: z.number().int().nullable(),
  remediatedCount: z.number().int().nullable(),
  remediationProgress: z.string().nullable(),
  remediationPriority: z.string().nullable(),
  remediationStatus: RemediationStatusEnum.nullable(),
  scanStartedAt: z.date().nullable(),
  scanCompletedAt: z.date().nullable(),
  createdAt: z.date(),
});
export const updateVulnerabilityScanSchema = selectVulnerabilityScanSchema.pick({
  projectId: true,
  repositoryId: true,
  scanType: true,
  scannerName: true,
  scannerVersion: true,
  targetType: true,
  targetIdentifier: true,
  totalVulnerabilities: true,
  criticalCount: true,
  highCount: true,
  mediumCount: true,
  lowCount: true,
  topFindings: true,
  mostSevereFinding: true,
  scanConfidence: true,
  overallRiskLevel: true,
  riskScore: true,
  aiAnalysisSummary: true,
  topRemediationSuggestion: true,
  estimatedFixTime: true,
  falsePositiveRate: true,
  highConfidenceFindings: true,
  remediatedCount: true,
  remediationProgress: true,
  remediationPriority: true,
  remediationStatus: true,
  scanStartedAt: true,
  scanCompletedAt: true,
}).partial();

export type VulnerabilityScan = typeof vulnerabilityScans.$inferSelect;
export type NewVulnerabilityScan = typeof vulnerabilityScans.$inferInsert;
export type UpdateVulnerabilityScan = z.infer<typeof updateVulnerabilityScanSchema>;
export type ScanType = z.infer<typeof ScanTypeEnum>;
export type TargetType = z.infer<typeof TargetTypeEnum>;