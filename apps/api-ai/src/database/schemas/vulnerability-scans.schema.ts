import { pgTable, serial, integer, text, timestamp, jsonb, index } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
import { createInsertSchema, createSelectSchema } from 'drizzle-zod';
import { z } from 'zod';
import { projects } from './projects.schema';
import { repositories } from './repositories.schema';

// 枚举定义
export const ScanTypeEnum = z.enum(['sast', 'dast', 'dependency', 'container', 'infrastructure']);
export const TargetTypeEnum = z.enum(['code', 'container', 'deployment', 'infrastructure']);

export const vulnerabilityScans = pgTable('vulnerability_scans', {
  id: serial('id').primaryKey(),
  projectId: integer('project_id').references(() => projects.id),
  repositoryId: integer('repository_id').references(() => repositories.id),
  
  // 扫描信息
  scanType: text('scan_type').notNull(), // 'sast', 'dast', 'dependency', 'container', 'infrastructure'
  scannerName: text('scanner_name').notNull(),
  scannerVersion: text('scanner_version'),
  
  // 扫描目标
  targetType: text('target_type').notNull(), // 'code', 'container', 'deployment', 'infrastructure'
  targetIdentifier: text('target_identifier').notNull(),
  
  // 扫描结果
  totalVulnerabilities: integer('total_vulnerabilities').default(0),
  criticalCount: integer('critical_count').default(0),
  highCount: integer('high_count').default(0),
  mediumCount: integer('medium_count').default(0),
  lowCount: integer('low_count').default(0),
  
  // 详细发现
  findings: jsonb('findings').default([]),
  
  // AI增强分析
  aiRiskAssessment: jsonb('ai_risk_assessment').default({}),
  aiRemediationSuggestions: jsonb('ai_remediation_suggestions').default([]),
  falsePositivePredictions: jsonb('false_positive_predictions').default([]),
  
  // 修复状态
  remediationStatus: jsonb('remediation_status').default({}),
  
  scanStartedAt: timestamp('scan_started_at'),
  scanCompletedAt: timestamp('scan_completed_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

// Indexes
export const vulnerabilityScansProjectIdx = index('vulnerability_scans_project_idx').on(vulnerabilityScans.projectId);
export const vulnerabilityScansRepositoryIdx = index('vulnerability_scans_repository_idx').on(vulnerabilityScans.repositoryId);
export const vulnerabilityScansScanTypeIdx = index('vulnerability_scans_scan_type_idx').on(vulnerabilityScans.scanType);
export const vulnerabilityScansTargetTypeIdx = index('vulnerability_scans_target_type_idx').on(vulnerabilityScans.targetType);
export const vulnerabilityScansCreatedAtIdx = index('vulnerability_scans_created_at_idx').on(vulnerabilityScans.createdAt);

// Relations
export const vulnerabilityScansRelations = relations(vulnerabilityScans, ({ one }) => ({
  project: one(projects, {
    fields: [vulnerabilityScans.projectId],
    references: [projects.id],
  }),
  repository: one(repositories, {
    fields: [vulnerabilityScans.repositoryId],
    references: [repositories.id],
  }),
}));

// Zod Schemas with detailed enums
export const insertVulnerabilityScanSchema = createInsertSchema(vulnerabilityScans);

export const selectVulnerabilityScanSchema = createSelectSchema(vulnerabilityScans);

export const updateVulnerabilityScanSchema = selectVulnerabilityScanSchema.pick({
  projectId: true,
  repositoryId: true,
  scanType: true,
  scannerName: true,
  scannerVersion: true,
  targetType: true,
  targetIdentifier: true,
  totalVulnerabilities: true,
  criticalCount: true,
  highCount: true,
  mediumCount: true,
  lowCount: true,
  findings: true,
  aiRiskAssessment: true,
  aiRemediationSuggestions: true,
  falsePositivePredictions: true,
  remediationStatus: true,
  scanStartedAt: true,
  scanCompletedAt: true,
}).partial();

export type VulnerabilityScan = typeof vulnerabilityScans.$inferSelect;
export type NewVulnerabilityScan = typeof vulnerabilityScans.$inferInsert;
export type UpdateVulnerabilityScan = z.infer<typeof updateVulnerabilityScanSchema>;
export type ScanType = z.infer<typeof ScanTypeEnum>;
export type TargetType = z.infer<typeof TargetTypeEnum>;