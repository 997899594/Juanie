# ğŸš€ Juanie AI - å¤šé˜¶æ®µDockeræ„å»º
# å®ç°é«˜æ•ˆçš„å®¹å™¨åŒ–éƒ¨ç½²å’Œè¾¹ç¼˜èŠ‚ç‚¹åˆ†å‘

# ============================================================================
# åŸºç¡€é•œåƒ - ä½¿ç”¨Alpine Linuxå‡å°‘é•œåƒå¤§å°
# ============================================================================
FROM node:20-alpine AS base

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    libc6-compat \
    python3 \
    make \
    g++ \
    curl \
    git \
    && rm -rf /var/cache/apk/*

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

# å®‰è£…pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# ============================================================================
# ä¾èµ–å®‰è£…é˜¶æ®µ
# ============================================================================
FROM base AS deps

# å¤åˆ¶åŒ…ç®¡ç†æ–‡ä»¶
COPY package.json pnpm-lock.yaml* ./

# å®‰è£…ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼Œç”¨äºæ„å»ºï¼‰
RUN pnpm install --frozen-lockfile

# ============================================================================
# æ„å»ºé˜¶æ®µ
# ============================================================================
FROM base AS builder

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN pnpm build

# æ¸…ç†å¼€å‘ä¾èµ–ï¼Œåªä¿ç•™ç”Ÿäº§ä¾èµ–
RUN pnpm prune --prod

# ============================================================================
# ç”Ÿäº§è¿è¡Œé˜¶æ®µ
# ============================================================================
FROM base AS runner

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 juanie

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶æ„å»ºäº§ç‰©å’Œç”Ÿäº§ä¾èµ–
COPY --from=builder --chown=juanie:nodejs /app/dist ./dist
COPY --from=builder --chown=juanie:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=juanie:nodejs /app/package.json ./package.json

# å¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶
COPY --from=builder --chown=juanie:nodejs /app/drizzle.config.ts ./
COPY --from=builder --chown=juanie:nodejs /app/tsconfig.json ./

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/logs /app/uploads /app/cache && \
    chown -R juanie:nodejs /app/logs /app/uploads /app/cache

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3000
ENV HOST=0.0.0.0

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 3000

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER juanie

# å¯åŠ¨åº”ç”¨
CMD ["node", "dist/main.js"]

# ============================================================================
# å¼€å‘é˜¶æ®µï¼ˆå¯é€‰ï¼‰
# ============================================================================
FROM base AS development

# å®‰è£…å¼€å‘å·¥å…·
RUN apk add --no-cache \
    bash \
    vim \
    htop \
    && rm -rf /var/cache/apk/*

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules

# å¤åˆ¶æºä»£ç 
COPY . .

# è®¾ç½®å¼€å‘ç¯å¢ƒå˜é‡
ENV NODE_ENV=development
ENV PORT=3000
ENV HOST=0.0.0.0

# æš´éœ²ç«¯å£ï¼ˆåŒ…æ‹¬è°ƒè¯•ç«¯å£ï¼‰
EXPOSE 3000 9229

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
CMD ["pnpm", "dev"]

# ============================================================================
# è¾¹ç¼˜èŠ‚ç‚¹ä¼˜åŒ–é˜¶æ®µ
# ============================================================================
FROM runner AS edge

# å®‰è£…è¾¹ç¼˜è®¡ç®—ä¼˜åŒ–å·¥å…·
USER root
RUN apk add --no-cache \
    redis \
    nginx \
    supervisor \
    && rm -rf /var/cache/apk/*

# åˆ›å»ºè¾¹ç¼˜ç¼“å­˜ç›®å½•
RUN mkdir -p /var/cache/edge /var/log/edge && \
    chown -R juanie:nodejs /var/cache/edge /var/log/edge

# è®¾ç½®è¾¹ç¼˜èŠ‚ç‚¹ç¯å¢ƒå˜é‡
ENV EDGE_MODE=true
ENV CACHE_STRATEGY=edge
ENV REDIS_URL=redis://localhost:6379

# åˆ‡æ¢å›érootç”¨æˆ·
USER juanie

# æš´éœ²è¾¹ç¼˜èŠ‚ç‚¹ç«¯å£
EXPOSE 80 443 6379

# å¯åŠ¨åº”ç”¨ï¼ˆè¾¹ç¼˜æ¨¡å¼ï¼‰
CMD ["node", "dist/main.js"]

# ============================================================================
# é•œåƒå…ƒæ•°æ®
# ============================================================================
LABEL maintainer="Juanie AI Team <dev@juanie.ai>"
LABEL version="1.0.0"
LABEL description="Juanie AI - Next-generation DevOps platform with AI-driven monitoring"
LABEL org.opencontainers.image.title="Juanie AI API"
LABEL org.opencontainers.image.description="AI-powered DevOps monitoring and automation platform"
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.vendor="Juanie AI"
LABEL org.opencontainers.image.licenses="MIT"
LABEL org.opencontainers.image.source="https://github.com/juanie-ai/platform"