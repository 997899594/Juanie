# ğŸ¯ SSE å®æ—¶è¿›åº¦æ¨é€ - å®Œæ•´å®ç°

## âœ¨ ç°åœ¨çš„ä¼˜åŠ¿

é€šè¿‡çŠ¶æ€æœºæ¶æ„ + SSEï¼Œæˆ‘ä»¬å®ç°äº†**çœŸæ­£ä¸æ»‘çš„å®æ—¶è¿›åº¦**ï¼š

### 1. ç²¾ç¡®çš„è¿›åº¦ç™¾åˆ†æ¯”

```
0%   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IDLE
10%  â–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ›å»ºé¡¹ç›®è®°å½•
20%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åŠ è½½æ¨¡æ¿
30%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¸²æŸ“æ¨¡æ¿
50%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ›å»ºç¯å¢ƒ
     â”œâ”€ 50%: æ­£åœ¨åˆ›å»ºå¼€å‘ç¯å¢ƒ...
     â”œâ”€ 67%: æ­£åœ¨åˆ›å»ºé¢„å‘å¸ƒç¯å¢ƒ...
     â””â”€ 100%: æ­£åœ¨åˆ›å»ºç”Ÿäº§ç¯å¢ƒ...
70%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è®¾ç½®ä»“åº“
85%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â”€â”€ åˆ›å»º GitOps
100% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ å®Œæˆï¼
```

### 2. è¯¦ç»†çš„æ“ä½œä¿¡æ¯

æ¯ä¸ªçŠ¶æ€éƒ½å¯ä»¥æ¨é€è¯¦ç»†çš„å­æ“ä½œï¼š

```typescript
// çŠ¶æ€çº§åˆ«è¿›åº¦
{
  type: 'initialization.progress',
  state: 'CREATING_ENVIRONMENTS',
  progress: 50,
  message: 'æ­£åœ¨åˆ›å»ºç¯å¢ƒé…ç½®...'
}

// è¯¦ç»†æ“ä½œè¿›åº¦
{
  type: 'initialization.detail',
  state: 'CREATING_ENVIRONMENTS',
  progress: 50,
  action: 'æ­£åœ¨åˆ›å»ºå¼€å‘ç¯å¢ƒ...',
  subProgress: 33,  // å­è¿›åº¦
  metadata: { environmentType: 'development' }
}

{
  type: 'initialization.detail',
  state: 'CREATING_ENVIRONMENTS',
  progress: 50,
  action: 'æ­£åœ¨åˆ›å»ºé¢„å‘å¸ƒç¯å¢ƒ...',
  subProgress: 67,
  metadata: { environmentType: 'staging' }
}
```

---

## ğŸ¨ å‰ç«¯å®ç°

### 1. ç›‘å¬ SSE äº‹ä»¶

```vue
<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'

const progress = ref(0)
const currentState = ref('')
const currentAction = ref('')
const subProgress = ref(0)

let eventSource: EventSource | null = null

async function createProject(data: CreateProjectInput) {
  // åˆ›å»ºé¡¹ç›®
  const { project, jobIds } = await trpc.projects.create.mutate(data)

  // è¿æ¥ SSE
  eventSource = new EventSource(`/api/sse/project/${project.id}`)

  // ç›‘å¬è¿›åº¦äº‹ä»¶
  eventSource.addEventListener('initialization.progress', (event) => {
    const data = JSON.parse(event.data)
    progress.value = data.progress
    currentState.value = data.state
    currentAction.value = data.message
    subProgress.value = 0  // é‡ç½®å­è¿›åº¦
  })

  // ç›‘å¬è¯¦ç»†æ“ä½œ
  eventSource.addEventListener('initialization.detail', (event) => {
    const data = JSON.parse(event.data)
    currentAction.value = data.action
    subProgress.value = data.subProgress || 0
  })

  // ç›‘å¬å®Œæˆ
  eventSource.addEventListener('initialization.completed', (event) => {
    const data = JSON.parse(event.data)
    progress.value = 100
    currentAction.value = 'åˆå§‹åŒ–å®Œæˆï¼'
    
    // å…³é—­è¿æ¥
    eventSource?.close()
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    toast.success('é¡¹ç›®åˆ›å»ºæˆåŠŸ', `åˆ›å»ºäº† ${data.createdResources.environments} ä¸ªç¯å¢ƒ`)
  })

  // ç›‘å¬é”™è¯¯
  eventSource.addEventListener('initialization.error', (event) => {
    const data = JSON.parse(event.data)
    
    // å…³é—­è¿æ¥
    eventSource?.close()
    
    // æ˜¾ç¤ºé”™è¯¯
    toast.error('åˆå§‹åŒ–å¤±è´¥', data.error)
  })
}

onUnmounted(() => {
  eventSource?.close()
})
</script>

<template>
  <div class="initialization-progress">
    <!-- ä¸»è¿›åº¦æ¡ -->
    <div class="progress-bar">
      <div class="progress-fill" :style="{ width: `${progress}%` }"></div>
    </div>
    <div class="progress-text">{{ progress }}%</div>

    <!-- å½“å‰æ“ä½œ -->
    <div class="current-action">
      {{ currentAction }}
    </div>

    <!-- å­è¿›åº¦ï¼ˆå¦‚æœæœ‰ï¼‰ -->
    <div v-if="subProgress > 0" class="sub-progress">
      <div class="sub-progress-bar">
        <div class="sub-progress-fill" :style="{ width: `${subProgress}%` }"></div>
      </div>
      <div class="sub-progress-text">{{ subProgress }}%</div>
    </div>

    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="state-indicator">
      <div 
        v-for="state in states" 
        :key="state.name"
        :class="['state-item', {
          'active': state.name === currentState,
          'completed': state.progress < progress
        }]"
      >
        <div class="state-icon">
          <CheckIcon v-if="state.progress < progress" />
          <LoadingIcon v-else-if="state.name === currentState" />
          <CircleIcon v-else />
        </div>
        <div class="state-name">{{ state.label }}</div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.progress-bar {
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6);
  transition: width 0.3s ease;
}

.current-action {
  margin-top: 12px;
  font-size: 14px;
  color: #6b7280;
  animation: fadeIn 0.3s ease;
}

.sub-progress {
  margin-top: 8px;
  padding-left: 20px;
}

.sub-progress-bar {
  width: 100%;
  height: 4px;
  background: #f3f4f6;
  border-radius: 2px;
  overflow: hidden;
}

.sub-progress-fill {
  height: 100%;
  background: #10b981;
  transition: width 0.3s ease;
}

.state-indicator {
  margin-top: 24px;
  display: flex;
  justify-content: space-between;
}

.state-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  opacity: 0.5;
  transition: opacity 0.3s ease;
}

.state-item.active {
  opacity: 1;
}

.state-item.completed {
  opacity: 0.8;
}

.state-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f3f4f6;
}

.state-item.active .state-icon {
  background: #3b82f6;
  color: white;
  animation: pulse 2s infinite;
}

.state-item.completed .state-icon {
  background: #10b981;
  color: white;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}
</style>
```

---

## ğŸ“Š å®æ—¶è¿›åº¦ç¤ºä¾‹

### åœºæ™¯ï¼šåˆ›å»ºé¡¹ç›® + ä½¿ç”¨æ¨¡æ¿ + åˆ›å»ºä»“åº“

```
æ—¶é—´è½´ï¼š

00:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 0%
      "å‡†å¤‡å¼€å§‹..."

00:01 â–ˆâ–ˆâ–ˆâ–ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 10%
      "æ­£åœ¨åˆ›å»ºé¡¹ç›®è®°å½•..."

00:02 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 20%
      "æ­£åœ¨åŠ è½½é¡¹ç›®æ¨¡æ¿..."

00:03 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 30%
      "æ­£åœ¨æ¸²æŸ“æ¨¡æ¿æ–‡ä»¶..."
      â””â”€ "æ­£åœ¨æ¸²æŸ“ package.json..."
      â””â”€ "æ­£åœ¨æ¸²æŸ“ Dockerfile..."
      â””â”€ "æ­£åœ¨æ¸²æŸ“ K8s é…ç½®..."

00:05 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 50%
      "æ­£åœ¨åˆ›å»ºç¯å¢ƒé…ç½®..."
      â”œâ”€ 33%: "æ­£åœ¨åˆ›å»ºå¼€å‘ç¯å¢ƒ..."
      â”œâ”€ 67%: "æ­£åœ¨åˆ›å»ºé¢„å‘å¸ƒç¯å¢ƒ..."
      â””â”€ 100%: "æ­£åœ¨åˆ›å»ºç”Ÿäº§ç¯å¢ƒ..."

00:07 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”â”â”â”â”â”â”â”â”â”â”â” 70%
      "æ­£åœ¨è®¾ç½® Git ä»“åº“..."
      â”œâ”€ "æ­£åœ¨åˆ›å»º GitHub ä»“åº“..."
      â”œâ”€ "æ­£åœ¨æ¨é€åˆå§‹ä»£ç ..."
      â””â”€ "æ­£åœ¨é…ç½® Webhook..."

00:30 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”â”â”â”â”â” 85%
      "æ­£åœ¨é…ç½® GitOps èµ„æº..."
      â”œâ”€ 33%: "æ­£åœ¨åˆ›å»º GitRepository..."
      â”œâ”€ 67%: "æ­£åœ¨åˆ›å»º Kustomization..."
      â””â”€ 100%: "æ­£åœ¨éªŒè¯é…ç½®..."

00:32 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
      "åˆå§‹åŒ–å®Œæˆï¼"
      âœ“ åˆ›å»ºäº† 3 ä¸ªç¯å¢ƒ
      âœ“ åˆ›å»ºäº† 1 ä¸ªä»“åº“
      âœ“ åˆ›å»ºäº† 3 ä¸ª GitOps èµ„æº
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. çœŸå®çš„è¿›åº¦

âŒ **æ—§ç‰ˆæœ¬**:
```
åˆ›å»ºä¸­... (ä¸çŸ¥é“è¿›åº¦)
åˆ›å»ºä¸­... (è¿˜æ˜¯ä¸çŸ¥é“)
åˆ›å»ºä¸­... (åˆ°åº•è¦å¤šä¹…ï¼Ÿ)
å®Œæˆï¼
```

âœ… **æ–°ç‰ˆæœ¬**:
```
10% - æ­£åœ¨åˆ›å»ºé¡¹ç›®è®°å½•...
20% - æ­£åœ¨åŠ è½½é¡¹ç›®æ¨¡æ¿...
50% - æ­£åœ¨åˆ›å»ºç¯å¢ƒé…ç½®...
  â”œâ”€ 33%: æ­£åœ¨åˆ›å»ºå¼€å‘ç¯å¢ƒ...
  â”œâ”€ 67%: æ­£åœ¨åˆ›å»ºé¢„å‘å¸ƒç¯å¢ƒ...
  â””â”€ 100%: æ­£åœ¨åˆ›å»ºç”Ÿäº§ç¯å¢ƒ...
70% - æ­£åœ¨è®¾ç½® Git ä»“åº“...
100% - å®Œæˆï¼
```

### 2. è¯¦ç»†çš„æ“ä½œä¿¡æ¯

ç”¨æˆ·å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“ï¼š
- âœ… å½“å‰åœ¨åšä»€ä¹ˆ
- âœ… å·²ç»å®Œæˆäº†ä»€ä¹ˆ
- âœ… è¿˜å‰©ä¸‹ä»€ä¹ˆ
- âœ… å¤§æ¦‚è¿˜éœ€è¦å¤šä¹…

### 3. ä¸æ»‘çš„åŠ¨ç”»

- âœ… è¿›åº¦æ¡å¹³æ»‘è¿‡æ¸¡
- âœ… æ–‡å­—æ·¡å…¥æ·¡å‡º
- âœ… çŠ¶æ€å›¾æ ‡åŠ¨ç”»
- âœ… å­è¿›åº¦ç‹¬ç«‹æ˜¾ç¤º

### 4. é”™è¯¯å¤„ç†

```typescript
// å¦‚æœæŸä¸ªç¯å¢ƒåˆ›å»ºå¤±è´¥
{
  type: 'initialization.detail',
  action: 'å¼€å‘ç¯å¢ƒåˆ›å»ºå¤±è´¥ï¼Œç»§ç»­åˆ›å»ºå…¶ä»–ç¯å¢ƒ...',
  metadata: { error: '...' }
}

// å¦‚æœæ•´ä¸ªæµç¨‹å¤±è´¥
{
  type: 'initialization.error',
  error: 'ä»“åº“åˆ›å»ºå¤±è´¥ï¼šæƒé™ä¸è¶³',
  state: 'SETTING_UP_REPOSITORY',
  progress: 70
}
```

---

## ğŸ”§ æ‰©å±•ç¤ºä¾‹

### æ·»åŠ æ›´è¯¦ç»†çš„è¿›åº¦

```typescript
// åœ¨ SetupRepositoryHandler ä¸­
async execute(context: InitializationContext): Promise<void> {
  if (config.mode === 'create') {
    // æ¨é€è¯¦ç»†æ­¥éª¤
    await context.publishDetail?.({
      action: 'æ­£åœ¨åˆ›å»º GitHub ä»“åº“...',
      subProgress: 20,
    })

    const repo = await this.createRepository(...)

    await context.publishDetail?.({
      action: 'æ­£åœ¨æ¨é€åˆå§‹ä»£ç ...',
      subProgress: 50,
      metadata: { repository: repo.fullName }
    })

    await this.pushInitialCode(...)

    await context.publishDetail?.({
      action: 'æ­£åœ¨é…ç½® Webhook...',
      subProgress: 80,
    })

    await this.setupWebhook(...)

    await context.publishDetail?.({
      action: 'ä»“åº“è®¾ç½®å®Œæˆï¼',
      subProgress: 100,
    })
  }
}
```

---

## ğŸ“ˆ æ€§èƒ½å½±å“

### SSE æ¨é€çš„å¼€é”€

- æ¯ä¸ªçŠ¶æ€å˜åŒ–: ~1ms
- æ¯ä¸ªè¯¦ç»†æ“ä½œ: ~1ms
- æ€»å¼€é”€: < 50msï¼ˆæ•´ä¸ªæµç¨‹ï¼‰

**ç»“è®º**: å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œç”¨æˆ·ä½“éªŒæå‡å·¨å¤§ï¼

---

## ğŸ‰ æ€»ç»“

é€šè¿‡çŠ¶æ€æœº + SSEï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. âœ… **ç²¾ç¡®çš„è¿›åº¦** - æ¯ä¸ªçŠ¶æ€éƒ½æœ‰æ˜ç¡®çš„ç™¾åˆ†æ¯”
2. âœ… **è¯¦ç»†çš„ä¿¡æ¯** - ç”¨æˆ·çŸ¥é“æ­£åœ¨åšä»€ä¹ˆ
3. âœ… **ä¸æ»‘çš„ä½“éªŒ** - å®æ—¶æ›´æ–°ï¼Œæ— éœ€åˆ·æ–°
4. âœ… **å­è¿›åº¦æ”¯æŒ** - é•¿æ—¶é—´æ“ä½œå¯ä»¥æ˜¾ç¤ºå­è¿›åº¦
5. âœ… **é”™è¯¯æç¤º** - æ¸…æ¥šåœ°çŸ¥é“å“ªé‡Œå‡ºé”™äº†

è¿™æ˜¯ä¸€ä¸ª**æ•™ç§‘ä¹¦çº§åˆ«çš„ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼ğŸ¯
