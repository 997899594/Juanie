# GitLab CI/CD Pipeline for Next.js 15
# æ”¯æŒ GitLab.com å’Œç§æœ‰ GitLab æœåŠ¡å™¨

variables:
  # Docker é…ç½®
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # é•œåƒä»“åº“é…ç½®ï¼ˆæ”¯æŒç§æœ‰ Registryï¼‰
  REGISTRY: ${CI_REGISTRY}  # ä½¿ç”¨ GitLab Container Registry
  IMAGE_NAME: ${CI_REGISTRY_IMAGE}
  
  # æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰ Registry
  # REGISTRY: registry.example.com
  # IMAGE_NAME: registry.example.com/group/project
  
  # Node.js ç‰ˆæœ¬
  NODE_VERSION: "20"
  
  # ç¼“å­˜é…ç½®
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  CYPRESS_CACHE_FOLDER: "$CI_PROJECT_DIR/.cache/Cypress"

# å®šä¹‰é˜¶æ®µ
stages:
  - prepare
  - test
  - build
  - deploy
  - cleanup

# ç¼“å­˜é…ç½®
.node_cache: &node_cache
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm
      - node_modules
      - .next/cache

# é»˜è®¤é…ç½®
default:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache git curl

# ==================== Prepare é˜¶æ®µ ====================

# å®‰è£…ä¾èµ–
install:
  stage: prepare
  <<: *node_cache
  script:
    - npm ci --prefer-offline --no-audit
  artifacts:
    paths:
      - node_modules
    expire_in: 1 hour

# ==================== Test é˜¶æ®µ ====================

# ä»£ç æ£€æŸ¥
lint:
  stage: test
  <<: *node_cache
  needs: [install]
  script:
    - npm run lint
  allow_failure: false

# ç±»å‹æ£€æŸ¥
type-check:
  stage: test
  <<: *node_cache
  needs: [install]
  script:
    - npm run type-check
  allow_failure: false

# å•å…ƒæµ‹è¯•
unit-test:
  stage: test
  <<: *node_cache
  needs: [install]
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage
    expire_in: 1 week

# æ„å»ºæµ‹è¯•
build-test:
  stage: test
  <<: *node_cache
  needs: [install]
  script:
    - npm run build
  variables:
    SKIP_ENV_VALIDATION: "true"
  artifacts:
    paths:
      - .next
    expire_in: 1 hour

# ==================== Build é˜¶æ®µ ====================

# æ„å»º Docker é•œåƒ
build-image:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  needs:
    - lint
    - type-check
    - unit-test
    - build-test
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # æ„å»ºé•œåƒæ ‡ç­¾
    - export IMAGE_TAG="${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    - export IMAGE_LATEST="${CI_COMMIT_REF_SLUG}-latest"
    
    # æ„å»ºé•œåƒ
    - |
      docker build \
        --cache-from ${IMAGE_NAME}:${IMAGE_LATEST} \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL} \
        -t ${IMAGE_NAME}:${IMAGE_TAG} \
        -t ${IMAGE_NAME}:${IMAGE_LATEST} \
        .
    
    # æ¨é€é•œåƒ
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
    - docker push ${IMAGE_NAME}:${IMAGE_LATEST}
    
    # å¦‚æœæ˜¯ä¸»åˆ†æ”¯ï¼Œæ‰“ latest æ ‡ç­¾
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
        docker push ${IMAGE_NAME}:latest
      fi
  only:
    - main
    - develop
    - tags

# ==================== Deploy é˜¶æ®µ ====================

# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
deploy:dev:
  stage: deploy
  image: alpine/k8s:1.28.3
  needs: [build-image]
  environment:
    name: development
    url: https://dev.{{ .appName }}.com
    on_stop: stop:dev
  before_script:
    - apk add --no-cache git
    # é…ç½® Git
    - git config --global user.email "gitlab-ci@{{ .appName }}.com"
    - git config --global user.name "GitLab CI"
  script:
    # å…‹éš† GitOps ä»“åº“
    - git clone https://oauth2:${GITOPS_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_NAMESPACE}/{{ .appName }}-gitops.git
    - cd {{ .appName }}-gitops
    
    # æ›´æ–°é•œåƒæ ‡ç­¾
    - cd overlays/dev
    - |
      kustomize edit set image app=${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
    
    # æäº¤å¹¶æ¨é€
    - git add .
    - git commit -m "ğŸš€ Deploy ${CI_COMMIT_SHORT_SHA} to dev [skip ci]"
    - git push origin main
    
    # ç­‰å¾…éƒ¨ç½²
    - echo "Waiting for Flux to sync..."
    - sleep 30
  only:
    - develop
  when: on_success

# åœæ­¢å¼€å‘ç¯å¢ƒï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
stop:dev:
  stage: deploy
  image: alpine/k8s:1.28.3
  environment:
    name: development
    action: stop
  script:
    - kubectl delete namespace {{ .appName }}-dev --ignore-not-found=true
  when: manual
  only:
    - develop

# éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
deploy:staging:
  stage: deploy
  image: alpine/k8s:1.28.3
  needs: [build-image]
  environment:
    name: staging
    url: https://staging.{{ .appName }}.com
  before_script:
    - apk add --no-cache git
    - git config --global user.email "gitlab-ci@{{ .appName }}.com"
    - git config --global user.name "GitLab CI"
  script:
    - git clone https://oauth2:${GITOPS_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_NAMESPACE}/{{ .appName }}-gitops.git
    - cd {{ .appName }}-gitops
    - cd overlays/staging
    - |
      kustomize edit set image app=${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
    - git add .
    - git commit -m "ğŸš€ Deploy ${CI_COMMIT_SHORT_SHA} to staging [skip ci]"
    - git push origin main
  only:
    - main
  when: manual

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
deploy:prod:
  stage: deploy
  image: alpine/k8s:1.28.3
  needs: [build-image]
  environment:
    name: production
    url: https://{{ .appName }}.com
  before_script:
    - apk add --no-cache git
    - git config --global user.email "gitlab-ci@{{ .appName }}.com"
    - git config --global user.name "GitLab CI"
  script:
    - git clone https://oauth2:${GITOPS_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_NAMESPACE}/{{ .appName }}-gitops.git
    - cd {{ .appName }}-gitops
    - cd overlays/prod
    - |
      kustomize edit set image app=${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
    - git add .
    - git commit -m "ğŸš€ Deploy ${CI_COMMIT_SHORT_SHA} to production [skip ci]"
    - git push origin main
    
    # åˆ›å»ºéƒ¨ç½²æ ‡ç­¾
    - git tag -a "deploy-$(date +%Y%m%d-%H%M%S)" -m "Production deployment ${CI_COMMIT_SHORT_SHA}"
    - git push --tags
  only:
    - main
  when: manual
  # éœ€è¦æ‰‹åŠ¨æ‰¹å‡†
  allow_failure: false

# ==================== E2E æµ‹è¯•ï¼ˆå¯é€‰ï¼‰====================

e2e-test:
  stage: deploy
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  needs: [deploy:dev]
  script:
    - npm ci
    - npx playwright install
    - npm run test:e2e
  variables:
    BASE_URL: https://dev.{{ .appName }}.com
  artifacts:
    when: always
    paths:
      - playwright-report
    expire_in: 1 week
  only:
    - develop
  allow_failure: true

# ==================== Cleanup é˜¶æ®µ ====================

# æ¸…ç†æ—§é•œåƒ
cleanup:
  stage: cleanup
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    # è·å–æ‰€æœ‰é•œåƒæ ‡ç­¾
    - |
      TAGS=$(curl --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/registry/repositories/${CI_REGISTRY_IMAGE}/tags" \
        | jq -r '.[].name')
    
    # åˆ é™¤è¶…è¿‡ 30 å¤©çš„é•œåƒï¼ˆä¿ç•™ latest å’Œæœ€è¿‘çš„æ ‡ç­¾ï¼‰
    - echo "Cleaning up old images..."
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘
  only:
    - schedules
  when: manual

# ==================== è§„åˆ™é…ç½® ====================

# åªåœ¨ç‰¹å®šåˆ†æ”¯è¿è¡Œ
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_ID
